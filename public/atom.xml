<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Adventures of a wannabe geek!]]></title>
  <link href="http://www.paulstack.co.uk/atom.xml" rel="self"/>
  <link href="http://www.paulstack.co.uk/"/>
  <updated>2016-01-19T10:48:42+00:00</updated>
  <id>http://www.paulstack.co.uk/</id>
  <author>
    <name><![CDATA[Paul Stack (@stack72)]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Building an Autodiscovering Apache Zookeeper Cluster in AWS using Packer, Ansible and Terraform]]></title>
    <link href="http://www.paulstack.co.uk/blog/2016/01/15/building-an-autodiscovering-apache-zookeeper-cluster-in-aws-using-packer-ansible-and-terraform/"/>
    <updated>2016-01-15T15:55:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2016/01/15/building-an-autodiscovering-apache-zookeeper-cluster-in-aws-using-packer-ansible-and-terraform</id>
    <content type="html"><![CDATA[<p>Following my <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">pattern</a> of building <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> for applications, I create my <a href="https://zookeeper.apache.org/">Apache Zookeeper</a> cluster with <a href="https://packer.io/">Packer</a> for my AMI and <a href="https://terraform.io/">Terraform</a> for the infrastructure. This Zookeeper cluster is auto-discovering of the other nodes that are determined to be in the cluster</p>

<h3>Building Zookeeper AMIs with Packer</h3>

<p>The packer template looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Zookeeper Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;zookeeper-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;zookeeper-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;zookeeper.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>   

<p>The install_dependencies.sh script is as described <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">previously</a></p>

<p>The ansible playbook for Zookeeper looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">zookeeper</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">exhibitor</span>
</span></code></pre></td></tr></table></div></figure>

<p>The base playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install zookeeper. As a last step, I install <a href="https://github.com/Netflix/exhibitor">exhibitor</a>. Exhibitor is a co-process for monitoring, backup/recovery, cleanup and visualization of zookeeper.</p>

<p>The zookeeper ansible role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Download ZooKeeper</span>
</span><span class='line'>  <span class="l-Scalar-Plain">get_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">url=http://www.mirrorservice.org/sites/ftp.apache.org/zookeeper/current/zookeeper-{{ zookeeper_version }}.tar.gz dest=/tmp/zookeeper-{{ zookeeper_version }}.tar.gz mode=0440</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Unpack Zookeeper</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tar xzf /tmp/zookeeper-{{ zookeeper_version }}.tar.gz -C /opt/ creates=/opt/zookeeper-{{ zookeeper_version }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Link to Zookeeper Directory</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=/opt/zookeeper-{{ zookeeper_version }}</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dest=/opt/zookeeper</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state=link</span>
</span><span class='line'>        <span class="l-Scalar-Plain">force=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create zookeeper group</span>
</span><span class='line'>  <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=zookeeper system=true state=present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create zookeeper user</span>
</span><span class='line'>  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=zookeeper groups=zookeeper system=true home=/opt/zookeeper</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Zookeeper Config Dir</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path={{zookeeper_conf_dir}} owner=zookeeper group=zookeeper recurse=yes state=directory mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Zookeeper Transations Dir</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/opt/zookeeper/transactions owner=zookeeper group=zookeeper recurse=yes state=directory mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Zookeeper Log Dir</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path={{zookeeper_log_dir}} owner=zookeeper group=zookeeper recurse=yes state=directory mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Zookeeper DataStore Dir</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path={{zookeeper_datastore_dir}} owner=zookeeper group=zookeeper recurse=yes state=directory mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Setup log4j</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dest=&quot;{{zookeeper_conf_dir}}/log4j.properties&quot; owner=root group=root mode=644 src=log4j.properties.j2</span>
</span></code></pre></td></tr></table></div></figure>

<p>The role itself is very simple. The zookeeper cluster is managed by exhibitor so there are very few settings passed to zookeeper at this point. One thing to note though, this requires an installation of the <a href="http://docs.oracle.com/javase/7/docs/webnotes/install/">Java JDK</a> to work.</p>

<p>The exhibitor playbook looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install Maven</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=maven state=latest update_cache=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Exhibitor Install Dir</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path={{ exhibitor_install_dir }} state=directory mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Exhibitor Build Dir</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path={{ exhibitor_install_dir }}/{{ exhibitor_version }} state=directory mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Exhibitor POM</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=pom.xml.j2</span>
</span><span class='line'>            <span class="l-Scalar-Plain">dest={{ exhibitor_install_dir }}/{{ exhibitor_version }}/pom.xml</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Build Exhibitor jar</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&#39;/usr/bin/mvn</span><span class="nv"> </span><span class="s">clean</span><span class="nv"> </span><span class="s">package</span><span class="nv"> </span><span class="s">-f</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">exhibitor_install_dir</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}/pom.xml</span><span class="nv"> </span><span class="s">creates={{</span><span class="nv"> </span><span class="s">exhibitor_install_dir</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}/target/exhibitor-{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Copy Exhibitor jar</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&#39;cp</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">exhibitor_install_dir</span><span class="nv"> </span><span class="s">}}/{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}/target/exhibitor-{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}.jar</span><span class="nv"> </span><span class="s">{{exhibitor_install_dir}}/exhibitor-standalone-{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}.jar</span><span class="nv"> </span><span class="s">creates={{exhibitor_install_dir}}/exhibitor-standalone-{{</span><span class="nv"> </span><span class="s">exhibitor_version</span><span class="nv"> </span><span class="s">}}.jar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Exhibitor Properties Config</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=exhibitor.properties.j2</span>
</span><span class='line'>            <span class="l-Scalar-Plain">dest={{ exhibitor_install_dir }}/exhibitor.properties</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">exhibitor upstart config</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=upstart.j2 dest=/etc/init/exhibitor.conf mode=644 owner=root</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=exhibitor state=started</span>
</span></code></pre></td></tr></table></div></figure>   

<p>This role has a lot more configuration to set as it essentially manages zookeeper. The <a href="https://gist.github.com/stack72/e5ccf1bb2bc5da484712">template files</a> for configuration are all available to download.</p>

<p>The variables for the entire playbook look as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">zookeeper_hosts</span><span class="p-Indicator">:</span> <span class="s">&quot;:2181&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">zookeeper_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3.4.6</span>
</span><span class='line'><span class="l-Scalar-Plain">zookeeper_conf_dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/zookeeper/conf</span>
</span><span class='line'><span class="l-Scalar-Plain">zookeeper_log_dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/log/zookeeper</span>
</span><span class='line'><span class="l-Scalar-Plain">zookeeper_datastore_dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/var/lib/zookeeper</span>
</span><span class='line'><span class="l-Scalar-Plain">zk_s3_bucket_name</span><span class="p-Indicator">:</span> <span class="s">&quot;mys3bucket&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">monasca_log_level</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">WARN</span>
</span><span class='line'><span class="l-Scalar-Plain">exhibitor_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.5.5</span>
</span><span class='line'><span class="l-Scalar-Plain">exhibitor_install_dir</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/opt/exhibitor</span>
</span></code></pre></td></tr></table></div></figure> 

<p>The main thing to note here is that the exhibitor process starts with the following configuration:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">exec </span>java -jar <span class="o">{{</span> exhibitor_install_dir <span class="o">}}</span>/exhibitor-standalone-<span class="o">{{</span>exhibitor_version<span class="o">}}</span>.jar --port 8181 --defaultconfig /opt/exhibitor/exhibitor.properties --configtype s3 --s3config <span class="o">{{</span> zk_s3_bucket_name <span class="o">}}</span>:<span class="o">{{</span> ansible_ec2_placement_region <span class="o">}}</span> --s3backup <span class="nb">true</span> --hostname <span class="o">{{</span> ec2_private_ip_address <span class="o">}}</span> &gt; /var/log/exhibitor.log 2&gt;&amp;1
</span></code></pre></td></tr></table></div></figure> 

<p>This means that the node will check itself into a configuration file in S3 and that all other zookeepers will read the same configuration file and can form the cluster required. You can read more about Exhibitor shared configuration on their <a href="https://github.com/Netflix/exhibitor/wiki/Shared-Configuration">github wiki</a>.</p>

<p>When I launch the instances now, the zookeeper cluster will be formed</p>

<h3>Deploying Zookeeper Infrastructure with Terraform</h3>

<p>The infrastructure of the Zookeeper cluster is pretty simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>resource <span class="s2">&quot;aws_security_group&quot;</span> <span class="s2">&quot;zookeeper&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;digit-zookeeper-sg&quot;</span>
</span><span class='line'>  <span class="nv">description</span> <span class="o">=</span> <span class="s2">&quot;Zookeeper Security Group&quot;</span>
</span><span class='line'>  <span class="nv">vpc_id</span> <span class="o">=</span> <span class="s2">&quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  ingress <span class="o">{</span>
</span><span class='line'>    <span class="nv">from_port</span> <span class="o">=</span> 0
</span><span class='line'>    <span class="nv">to_port</span>   <span class="o">=</span> 0
</span><span class='line'>    <span class="nv">protocol</span>  <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
</span><span class='line'>    <span class="nv">cidr_blocks</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  egress <span class="o">{</span>
</span><span class='line'>    <span class="nv">from_port</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
</span><span class='line'>    <span class="nv">to_port</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
</span><span class='line'>    <span class="nv">protocol</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
</span><span class='line'>    <span class="nv">cidr_blocks</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  tags <span class="o">{</span>
</span><span class='line'>    <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;ZooKeeper Node&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_launch_configuration&quot;</span> <span class="s2">&quot;zookeeper_launch_config&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">image_id</span> <span class="o">=</span> <span class="s2">&quot;${var.zookeeper_ami_id}&quot;</span>
</span><span class='line'>  <span class="nv">instance_type</span> <span class="o">=</span> <span class="s2">&quot;${var.zookeeper_instance_type}&quot;</span>
</span><span class='line'>  <span class="nv">iam_instance_profile</span> <span class="o">=</span> <span class="s2">&quot;zookeeper-server&quot;</span>
</span><span class='line'>  <span class="nv">key_name</span> <span class="o">=</span> <span class="s2">&quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="nv">security_groups</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;${aws_security_group.zookeeper.id}&quot;</span>,<span class="s2">&quot;${aws_security_group.node.id}&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="nv">enable_monitoring</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="nb">  </span>lifecycle <span class="o">{</span>
</span><span class='line'>    <span class="nv">create_before_destroy</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  root_block_device <span class="o">{</span>
</span><span class='line'>    <span class="nv">volume_size</span> <span class="o">=</span> <span class="s2">&quot;${var.digit_zookeeper_volume_size}&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>resource <span class="s2">&quot;aws_autoscaling_group&quot;</span> <span class="s2">&quot;zookeeper_autoscale_group&quot;</span> <span class="o">{</span>
</span><span class='line'>  <span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;zookeeper-autoscale-group&quot;</span>
</span><span class='line'>  <span class="nv">availability_zones</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;${aws_subnet.primary-private.availability_zone}&quot;</span>,<span class="s2">&quot;${aws_subnet.secondary-private.availability_zone}&quot;</span>,<span class="s2">&quot;${aws_subnet.tertiary-private.availability_zone}&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="nv">vpc_zone_identifier</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;${aws_subnet.primary-private.id}&quot;</span>,<span class="s2">&quot;${aws_subnet.secondary-private.id}&quot;</span>,<span class="s2">&quot;${aws_subnet.tertiary-private.id}&quot;</span><span class="o">]</span>  <span class="nv">launch_configuration</span> <span class="o">=</span> <span class="s2">&quot;${aws_launch_configuration.zookeeper_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="nv">min_size</span> <span class="o">=</span> 0
</span><span class='line'>  <span class="nv">max_size</span> <span class="o">=</span> 100
</span><span class='line'>  <span class="nv">desired</span> <span class="o">=</span> 3
</span><span class='line'>
</span><span class='line'>  tag <span class="o">{</span>
</span><span class='line'>    <span class="nv">key</span> <span class="o">=</span> <span class="s2">&quot;Name&quot;</span>
</span><span class='line'>    <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;zookeeper&quot;</span>
</span><span class='line'>    <span class="nv">propagate_at_launch</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  tag <span class="o">{</span>
</span><span class='line'>    <span class="nv">key</span> <span class="o">=</span> <span class="s2">&quot;role&quot;</span>
</span><span class='line'>    <span class="nv">value</span> <span class="o">=</span> <span class="s2">&quot;zookeeper&quot;</span>
</span><span class='line'>    <span class="nv">propagate_at_launch</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>When Terraform is applied here, a 3 node cluster of zookeeper will be created. You can go to <a href="http://mynodeip:8181/exhibitor/v1/ui/index.html">exhibitor</a> and see the configuration e.g.</p>

<p><img src="http://www.paulstack.co.uk/images/exhibitor-zookeeper-cluster.png" alt="Image">
<img src="http://www.paulstack.co.uk/images/exhibitor-zookeeper-cluster-config.png" alt="Image"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Replacing a node in a Riak Cluster]]></title>
    <link href="http://www.paulstack.co.uk/blog/2016/01/15/replacing-a-node-in-a-riak-cluster/"/>
    <updated>2016-01-15T11:03:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2016/01/15/replacing-a-node-in-a-riak-cluster</id>
    <content type="html"><![CDATA[<p>The instances that run in my infrastructure get a lifespan of 14 days. This allows me to continually test that I can replace my environment at any point. People always ask me if I follow the same principal for data nodes. I posted <a href="http://www.paulstack.co.uk/blog/2016/01/04/replacing-the-nodes-in-an-aws-elasticsearch-cluster/">previously</a> about replacing nodes is an <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> cluster, this post will detail how I replace  nodes in a <a href="http://basho.com/products/riak-kv/">Riak</a> cluster </p>

<p><strong><em>NOTE</em></strong>: This post assumes that you have the <a href="http://docs.basho.com/riak/latest/ops/advanced/riak-control/">Riak Control console</a> enabled for Riak. You can find out how to enable that in the <a href="http://www.paulstack.co.uk/blog/2016/01/06/building-a-riak-cluster-in-aws-with-packer-and-terraform/">post</a> I wrote on configuring Riak.</p>

<p>When going to the Riak Control, you can find the following screens:</p>

<p><em>Cluster Health</em></p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-cluster-health.png" alt="Image"></p>

<p><em>Ring Status</em></p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-ring-status.png" alt="Image"></p>

<p><em>Cluster Management</em> </p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-cluster-mgmt.png" alt="Image"></p>

<p><em>Node Management</em></p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-node-mgmt.png" alt="Image"></p>

<h3>Removing a node from the Cluster</h3>

<p>In order to remove a node from the cluster, go to the cluster managemenet screen. Find the node you want to replace in the list and click on the <code>Actions</code> toggle. It will reveal actions as follows:</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-cluster-node-options.png" alt="Image"></p>

<p>As the node is currently running, I tend to chose the <code>Allow this node to leave normally</code> option (if the node had died or was unresponsive, I would usually chose the <code>force this node to leave</code>). Clicking on the <code>Stage</code> button, details a plan of what is going to happen:</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-remove-node.png" alt="Image"></p>

<p>If the proposed changes look good, <code>Commit</code> the plan. Watch the partitions drain from the node to be replaced:</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-node-draining.png" alt="Image"></p>

<p>When the all the partitions have drained, we now have a 2 node cluster where the partitons are split 50:50:</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-smaller-cluster.png" alt="Image"></p>

<p>We can now destroy the node and let the <a href="https://aws.amazon.com/autoscaling/">autoscaling group</a> launch another to replace it</p>

<h3>Adding a new node to the Cluster</h3>

<p>Assuming a new node has already been launched and is ready to go into the cluster. Go to the cluster management page in the portal and enter new node details. It should follow the format <code>riak@&lt;ipaddress&gt;</code></p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-add-new-node.png" alt="Image"></p>

<p>The list of actions that are pending on the cluster:</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-stage-new-node.png" alt="Image"></p>

<p><code>Commit</code> the changes, watch the partions rebalance across the cluster:</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-cluster-rebalance.png" alt="Image"></p>

<p>The cluster will return to being 3 nodes, with equal partition split and will then show as green again</p>

<p><img src="http://www.paulstack.co.uk/images/riak-control-green-cluster.png" alt="Image"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building a Riak Cluster in AWS with Packer and Terraform]]></title>
    <link href="http://www.paulstack.co.uk/blog/2016/01/06/building-a-riak-cluster-in-aws-with-packer-and-terraform/"/>
    <updated>2016-01-06T15:02:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2016/01/06/building-a-riak-cluster-in-aws-with-packer-and-terraform</id>
    <content type="html"><![CDATA[<p>Following my <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">pattern</a> of building <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> for applications, I create my <a href="http://basho.com/products/riak-kv/">riak</a> cluster with <a href="https://packer.io/">Packer</a> for my AMI and <a href="https://terraform.io/">Terraform</a> for the infrastructure</p>

<h3>Building Riak AMIs with Packer</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Riak Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;riak-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;riak-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;riak.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The install_dependencies.sh script is as described <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">previously</a></p>

<p>The ansible playbook for Riak looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">riak</span>
</span></code></pre></td></tr></table></div></figure>

<p>The base playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install riak.</p>

<p>The riak ansible role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt_key url={{ riak_key_url }} state=present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt_repository repo=&#39;{{ riak_deb_repo }}&#39; state=present update_cache=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=riak={{ riak_version }} state=present update_cache=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">set ulimit</span>
</span><span class='line'>  <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=etc-default-riak dest=/etc/default/riak owner=root group=root mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">template riak configuration</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=riak.j2 dest=/etc/riak/riak.conf owner=riak mode=0644</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart_riak</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart riak</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=riak state=started</span>
</span></code></pre></td></tr></table></div></figure>

<p>The role itself is very simple. The riak cluster settings are all held in the <a href="https://gist.github.com/stack72/e0df60305aff136cb81c">riak.j2</a> template file. Notice that the riak template has the following line in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">riak_control = on</span>
</span></code></pre></td></tr></table></div></figure>

<p>The variables for the riak playbook look as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">riak_key_url</span><span class="p-Indicator">:</span> <span class="s">&quot;https://packagecloud.io/gpg.key&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">riak_deb_repo</span><span class="p-Indicator">:</span> <span class="s">&quot;deb</span><span class="nv"> </span><span class="s">https://packagecloud.io/basho/riak/ubuntu/</span><span class="nv"> </span><span class="s">trusty</span><span class="nv"> </span><span class="s">main&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">riak_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2.1.1-1</span>
</span></code></pre></td></tr></table></div></figure> 

<h3>Deploying Riak with Terraform</h3>

<p>The infrastructure of the Riak cluster is pretty simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_elb&quot; &quot;riak_v2_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-elb-v2&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">subnets = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.riak_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cross_zone_load_balancing = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_draining = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">internal = true</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthy_threshold   = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">unhealthy_threshold = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval            = 10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">target              = &quot;HTTP:8098/ping&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout             = 5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;riak&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Riak Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.riak_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Riak Node&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group_rule&quot; &quot;riak_all_tcp&quot; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type = &quot;ingress&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 0</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = 65535</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_group_id = &quot;${aws_security_group.riak.id}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">source_security_group_id = &quot;${aws_security_group.riak.id}&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;riak_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-elb-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Riak Elastic Load Balancer Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Riak Load Balancer&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_autoscaling_group&quot; &quot;riak_v2_autoscale_group&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-v2-autoscale-group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">availability_zones = [&quot;${aws_subnet.primary-private.availability_zone}&quot;,&quot;${aws_subnet.secondary-private.availability_zone}&quot;,&quot;${aws_subnet.tertiary-private.availability_zone}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_zone_identifier = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">launch_configuration = &quot;${aws_launch_configuration.riak_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">min_size = 0</span>
</span><span class='line'>  <span class="l-Scalar-Plain">max_size = 100</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_type = &quot;EC2&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;Name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;riak&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;role&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;riak&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${aws_elb.riak_v2_elb.name}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_region&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${var.aws_region}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_launch_configuration&quot; &quot;riak_launch_config&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image_id = &quot;${var.riak_ami_id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">instance_type = &quot;${var.riak_instance_type}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">iam_instance_profile = &quot;app-server&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">key_name = &quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.riak.id}&quot;,&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enable_monitoring = false</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">lifecycle {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">create_before_destroy = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">root_block_device {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volume_size = &quot;${var.driak_volume_size}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Replacing the Nodes in an AWS ElasticSearch Cluster]]></title>
    <link href="http://www.paulstack.co.uk/blog/2016/01/04/replacing-the-nodes-in-an-aws-elasticsearch-cluster/"/>
    <updated>2016-01-04T17:01:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2016/01/04/replacing-the-nodes-in-an-aws-elasticsearch-cluster</id>
    <content type="html"><![CDATA[<p>In a <a href="http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">previous post</a>, I talked about how I have tended towards the philosophy of &#39;Immutable Infrastructure&#39;. As part of that philospohy, when a box is created in my environment, it has a lifespan of 14 days. On the 14th day, I get a notification to tell me that the box is due for renewal. When it comes to <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> nodes, there is a process I follow to renew a box. </p>

<p>I have an example 3 nodes cluster of ElasticSearch up and running to test this on:</p>

<p><img src="http://www.paulstack.co.uk/images/aws_elasticsearch_cluster.png" alt="Image"></p>

<p>Let&#39;s assume that instance <em>i-</em> was due for renewal. Firstly, I would usually disable shard reallocation. This will stop unnecessary data transfer between nodes and minimise the wastage of I/O.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPUT localhost:9200/_cluster/settings -d '{
</span><span class='line'>                "transient" : {
</span><span class='line'>                    "cluster.routing.allocation.enable" : "none"
</span><span class='line'>                }
</span><span class='line'>        }'</span></code></pre></td></tr></table></div></figure>

<p>As these shard allocation is now disabled, I can continue with the node replacement. There are a few ways to do this. Previously to ElasticSearch 2.0, we could do it with the ElasticSearch API:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPOST 'http://localhost:9200/_cluster/nodes/MYNODEIP/_shutdown'</span></code></pre></td></tr></table></div></figure>

<p>If you are using ElasticSearch 2.0, you are more than likely running ElasticSearch as a service. To shutdown the node, stop the service.</p>

<p>By looking at the status of the cluster now, I can see the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "elasticsearch",
</span><span class='line'>  "status" : "yellow",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 2,
</span><span class='line'>  "number_of_data_nodes" : 2,
</span><span class='line'>  "active_primary_shards" : 160,
</span><span class='line'>  "active_shards" : 317,
</span><span class='line'>  "relocating_shards" : 0,
</span><span class='line'>  "initializing_shards" : 2,
</span><span class='line'>  "unassigned_shards" : 151,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>I can see that it tells me the cluster is yellow and that I have 2 nodes in it. I can proceed with the instance termination.</p>

<p><img src="http://www.paulstack.co.uk/images/aws_elasticsearch_instance_terminated.png" alt="Image"></p>

<p>I have an AWS <a href="https://aws.amazon.com/autoscaling/">Autoscale Group</a> configured for ElasticSearch to keep 3 instances running. Therefore, the node that I destroyed will fail the Autoscale Group Healthcheck and a new instance will be spawned to replace it.</p>

<p>Using the ElasticSearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html">Cluster Health API</a>, I can determine when the new node is in place:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?wait_for_nodes=3&timeout=100s'</span></code></pre></td></tr></table></div></figure> 

<p>The command will continue running until the cluster has 3 nodes in it. If you want to replace more nodes in the cluster, then repeat the steps above. If you are finished, then it is important to re-enable the shard reallocation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPUT localhost:9200/_cluster/settings -d '{
</span><span class='line'>                "transient" : {
</span><span class='line'>                    "cluster.routing.allocation.enable" : "all"
</span><span class='line'>                }
</span><span class='line'>        }'</span></code></pre></td></tr></table></div></figure>

<p>The time taken to rebalance the cluster will depend on the number and size of the shards.</p>

<p>You can monitor the health of the cluster until it turns green:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?wait_for_status=green&timeout=100s'</span></code></pre></td></tr></table></div></figure>

<p>The cluster is now green and all is working as expected again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "elasticsearch",
</span><span class='line'>  "status" : "green",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 3,
</span><span class='line'>  "number_of_data_nodes" : 3,
</span><span class='line'>  "active_primary_shards" : 160,
</span><span class='line'>  "active_shards" : 470,
</span><span class='line'>  "relocating_shards" : 1,
</span><span class='line'>  "initializing_shards" : 0,
</span><span class='line'>  "unassigned_shards" : 0,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deploying Kibana Using Nginx as an SSL Proxy]]></title>
    <link href="http://www.paulstack.co.uk/blog/2016/01/03/deploying-kibana-using-nginx-as-an-ssl-proxy/"/>
    <updated>2016-01-03T01:16:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2016/01/03/deploying-kibana-using-nginx-as-an-ssl-proxy</id>
    <content type="html"><![CDATA[<p>In my last <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">post</a>, I described how I use <a href="https://packer.io/">Packer</a> and <a href="https://terraform.io/">Terraform</a> to deploy an <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> cluster. In order to make the logs stored in ElasticSearch searchable, I use <a href="https://www.elastic.co/products/kibana">Kibana</a>. I follow the previous pattern and deploy Kibana using Packer to build an <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.htm">AMI</a> and then create the infrastructure using Terraform. The Packer template has already taken into account that I want to use <a href="https://www.nginx.com/">nginx</a> as a proxy. </p>

<h3>Building Kibana AMIs with Packer and Ansible</h3>

<p>The template looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Kibana Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;kibana-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;kibana-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;kibana.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
 

<p>The install_dependencies.sh script is as described <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">previously</a></p>

<p>The ansible playbook for Kibana looks as follows:  </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kibana</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">reverse_proxied</span>
</span></code></pre></td></tr></table></div></figure>

<p>The playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install ElasticSearch.</p>

<p>The Kibana role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Download Kibana</span>
</span><span class='line'>  <span class="l-Scalar-Plain">get_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">url=https://download.elasticsearch.org/kibana/kibana/kibana-{{ kibana_version }}-linux-x64.tar.gz dest=/tmp/kibana-{{ kibana_version }}-linux-x64.tar.gz mode=0440</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Untar Kibana</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tar xzf /tmp/kibana-{{ kibana_version }}-linux-x64.tar.gz -C /opt creates=/opt/kibana-{{ kibana_version }}-linux-x64.tar.gz</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Link to Kibana Directory</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=/opt/kibana-{{ kibana_version }}-linux-x64</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dest=/opt/kibana</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state=link</span>
</span><span class='line'>        <span class="l-Scalar-Plain">force=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Link Kibana to ElasticSearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">lineinfile</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
</span><span class='line'>    <span class="no">dest=/opt/kibana/config/kibana.yml</span>
</span><span class='line'>    <span class="no">regexp=&quot;^elasticsearch_url:&quot;</span>
</span><span class='line'>    <span class="no">line=&#39;elasticsearch_url: &quot;{{ elasticsearch_url }}&quot;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Kibana Init Script</span>
</span><span class='line'>  <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=initd.conf dest=/etc/init.d/kibana mode=755 owner=root</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ensure Kibana is running</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=kibana state=started</span>
</span></code></pre></td></tr></table></div></figure>

<p>The reverse_proxied ansible role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">download private key file</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws s3 cp {{ reverse_proxy_private_key_s3_path }} /etc/ssl/private/{{ reverse_proxy_private_key }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">private key permissions</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/etc/ssl/private/{{ reverse_proxy_private_key }} mode=600</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">download certificate file</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws s3 cp {{ reverse_proxy_cert_s3_path }} /etc/ssl/certs/{{ reverse_proxy_cert }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">download DH 2048bit encryption</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws s3 cp {{ reverse_proxy_dh_pem_s3_path }} /etc/ssl/{{ reverse_proxy_dh_pem }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">certificate permissions</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/etc/ssl/certs/{{ reverse_proxy_cert }} mode=644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=nginx</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">remove default nginx site from sites-emabled</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/etc/nginx/sites-enabled/default state=absent</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=nginx.conf.j2 dest=/etc/nginx/nginx.conf mode=644 owner=root group=root</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=restarted</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/var/log/nginx</span>
</span><span class='line'>        <span class="l-Scalar-Plain">mode=0755</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state=directory</span>
</span></code></pre></td></tr></table></div></figure>

<p>This role downloads a private SSL Key and a Certificate from a <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html">S3 bucket</a> that is security controlled through <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html">IAM</a>. This allows us to configure nginx to act as a proxy. The nginx proxy template is available to <a href="https://gist.github.com/stack72/1d76839c6783bd7eea33">view</a>.</p>

<p>We can then pass a number of variables to our role for use within ansible:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">reverse_proxy_private_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mydomain.key</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_private_key_s3_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3://my-bucket/certs/mydomain/mydomain.key</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_cert</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mydomain.crt</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_cert_s3_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3://my-bucket/certs/mydomain/mydomain.crt</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_dh_pem_s3_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3://my-bucket/certs/dhparams.pem</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_dh_pem</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dhparams.pem</span>
</span><span class='line'><span class="l-Scalar-Plain">proxy_urls</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">reverse_proxy_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
</span><span class='line'>    <span class="l-Scalar-Plain">reverse_proxy_upstream_port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3000</span>
</span><span class='line'><span class="l-Scalar-Plain">kibana_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4.1.0</span>
</span><span class='line'><span class="l-Scalar-Plain">elasticsearch_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://myes.com:9200</span>
</span></code></pre></td></tr></table></div></figure>

<p>This allows me to easily change the configuration of nginx to patch security vulnerabilities easily.</p>

<h3>Deploying Kibana with Terraform</h3>

<p>The infrastructure of the Kibana cluster is now pretty easy. The Terraform script now looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;kibana&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Kibana Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Kibana Node&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;kibana_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-elb-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Kibana Elastic Load Balancer Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Kibana Load Balancer&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_elb&quot; &quot;kibana_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-elb&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">subnets = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cross_zone_load_balancing = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_draining = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">internal = true</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthy_threshold   = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">unhealthy_threshold = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval            = 10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">target              = &quot;TCP:443&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout             = 5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_launch_configuration&quot; &quot;kibana_launch_config&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image_id = &quot;${var.kibana_ami_id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">instance_type = &quot;${var.kibana_instance_type}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">iam_instance_profile = &quot;app-server&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">key_name = &quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana.id}&quot;,&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enable_monitoring = false</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">root_block_device {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volume_size = &quot;${var.kibana_volume_size}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">lifecycle {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">create_before_destroy = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_autoscaling_group&quot; &quot;kibana_autoscale_group&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-autoscale-group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">availability_zones = [&quot;${aws_subnet.primary-private.availability_zone}&quot;,&quot;${aws_subnet.secondary-private.availability_zone}&quot;,&quot;${aws_subnet.tertiary-private.availability_zone}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_zone_identifier = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">launch_configuration = &quot;${aws_launch_configuration.kibana_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">min_size = 2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">max_size = 100</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_type = &quot;EC2&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">load_balancers = [&quot;${aws_elb.kibana_elb.name}&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;Name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;kibana&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;role&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;kibana&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${aws_elb.kibana_elb.name}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_region&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${var.aws_region}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This allows me to scale my system up or down just by changing the values in my Terraform configuration. When the instances are instantiated, the Kibana instances are added to the ELB and they are then available to serve traffic</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Building an ElasticSearch cluster in AWS with Packer and Terraform]]></title>
    <link href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/"/>
    <updated>2016-01-02T12:47:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform</id>
    <content type="html"><![CDATA[<p>As discussed in a <a href="http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">previous post</a>, I like to build separate <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> for each of my systems. This allows me to scale up and recycle nodes easily. I have been doing this with <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> for a while now. I usually build an AMI with <a href="https://packer.io/">Packer</a> and <a href="http://www.ansible.com/">Ansible</a> and I use <a href="https://terraform.io/">Terraform</a> to roll out the infrastructure</p>

<h3>Building ElasticSearch AMIs with Packer</h3>

<p>The packer template looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;ElasticSearch Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;elasticsearch-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;elasticsearch-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;elasticsearch.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is essentially a pretty simple script and builds an AWS Instance in a private subnet of my choice in eu-west-1a in AWS. </p>

<h4>install_dependencies.sh</h4>

<p>The first part of the script just installs the dependencies that my system has:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'>apt-get update
</span><span class='line'>apt-get upgrade -y
</span><span class='line'>apt-get install -y software-properties-common git
</span><span class='line'>apt-add-repository -y ppa:ansible/ansible apt-get update
</span><span class='line'>
</span><span class='line'><span class="c"># workaround for ubuntu pip bug - https://bugs.launchpad.net/ubuntu/+source/python-pip/+bug/1306991</span>
</span><span class='line'>rm -rf /usr/local/lib/python2.7/dist-packages/requests
</span><span class='line'>apt-get install -y python-dev
</span><span class='line'>
</span><span class='line'>ssh-keyscan -H github.com &gt; /etc/ssh/ssh_known_hosts
</span><span class='line'>
</span><span class='line'>wget https://raw.github.com/pypa/pip/master/contrib/get-pip.py
</span><span class='line'>python get-pip.py
</span><span class='line'>
</span><span class='line'>pip install ansible paramiko PyYAML jinja2 httplib2 netifaces boto awscli six
</span></code></pre></td></tr></table></div></figure>

<h4>Ansible playbook for ElasticSearch</h4>

<p>The ElasticSearch playbook looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">elasticsearch</span>
</span></code></pre></td></tr></table></div></figure>

<p>The playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install ElasticSearch. </p>

<p>The ElasticSearch role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add Oracle Java Repository</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt_repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">repo=&#39;ppa:webupd8team/java&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Accept Java 8 Licence</span>
</span><span class='line'>  <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | tee /etc/oracle-java-8-licence-acceptance | /usr/bin/debconf-set-selections</span>
</span><span class='line'>  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">creates</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/oracle-java-8-licence-acceptance</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add ElasticSearch repo public signing key</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">id=46095ACC8548582C1A2699A9D27D666CD88E42B4 url=https://packages.elastic.co/GPG-KEY-elasticsearch state=present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add ElasticSearch repository</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt_repository</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">repo</span><span class="p-Indicator">:</span> <span class="s">&#39;deb</span><span class="nv"> </span><span class="s">http://packages.elasticsearch.org/elasticsearch/{{</span><span class="nv"> </span><span class="s">es_release</span><span class="nv"> </span><span class="s">}}/debian</span><span class="nv"> </span><span class="s">stable</span><span class="nv"> </span><span class="s">main&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install Oracle Java 8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name={{item}} state=latest</span>
</span><span class='line'>  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oracle-java8-installer</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ca-certificates</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oracle-java8-set-default</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install ElasticSearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=elasticsearch={{ es_version }} state=present</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Copy /etc/default/elasticsearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=elasticsearch dest=/etc/default/elasticsearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Copy /etc/elasticsearch/elasticsearch.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=elasticsearch.yml dest=/etc/elasticsearch/elasticsearch.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set elasticsearch service to start on boot</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=elasticsearch enabled=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install plugins</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bin/plugin --install {{item.name}}</span>
</span><span class='line'>  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">chdir</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">es_home</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">creates</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">es_home</span><span class="nv"> </span><span class="s">}}/plugins/{{</span><span class="nv"> </span><span class="s">item.plugin_file</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(item.name.split(&#39;/&#39;)[1])</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">es_plugins</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set elasticsearch to be running</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=elasticsearch state=running enabled=yes</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is just some basic ansible commands to get the apt-repo, packages and plugins installed in the system. You can find the templates used <a href="https://gist.github.com/stack72/bdef4126ae8b08214bd8">here</a>. The important part to note is that variables are used both in the script <strong>and</strong> in the templates to setup the cluster to the required level.</p>

<p>My variables look as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="l-Scalar-Plain">es_release</span><span class="p-Indicator">:</span> <span class="s">&quot;1.6&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">es_version</span><span class="p-Indicator">:</span> <span class="s">&quot;.0&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">es_home</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/elasticsearch</span>
</span><span class='line'><span class="l-Scalar-Plain">es_wait_for_listen</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'><span class="l-Scalar-Plain">es_etc</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cluster_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">central_logging_cluster</span>
</span><span class='line'>  <span class="l-Scalar-Plain">discovery.type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ec2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">discovery.ec2.groups</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">elasticsearch-sg</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cloud.aws.region</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">es_default_es_heap_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4g</span>
</span><span class='line'><span class="l-Scalar-Plain">es_plugins</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">elasticsearch/elasticsearch-cloud-aws/2.6.0</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">elasticsearch/marvel/latest</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mobz/elasticsearch-head</span>
</span><span class='line'><span class="l-Scalar-Plain">es_etc_index_number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span></code></pre></td></tr></table></div></figure>

<p>As I have specified <code>elasticsearch-sg</code> and installed the <code>elasticsearch-cloud-aws</code> plugin, my nodes can auto-discover each other in the aws region. I can build the packer image as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="c1">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">LATEST_UBUNTU_IMAGE=$(curl http://cloud-images.ubuntu.com/locator/ec2/releasesTable | grep eu-west-1 | grep trusty | grep amd64 | grep &quot;\&quot;hvm:ebs\&quot;&quot; | awk -F &quot;[&lt;&gt;]&quot; &#39;{print $3}&#39;)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">packer build \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var ami_id=$LATEST_UBUNTU_IMAGE \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var security_group_id=MYSGID\</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var private_subnet_id=MYSUBNETID \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var packer_build_number=PACKERBUILDNUMBER \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">elasticsearch.json</span>
</span></code></pre></td></tr></table></div></figure>

<p>We are now ready to build the infrastructure for the cluster</p>

<h3>Building an ElasticSearch Cluster with Terraform</h3>

<p>The infrastructure of the ElasticSearch cluster is now pretty easy. I deploy my nodes into a <a href="https://aws.amazon.com/vpc/">VPC</a> and onto private subnets so that they are not externally accessible. I have an <a href="https://aws.amazon.com/elasticloadbalancing/">ELB</a> in place across the nodes so that I can easily get to the ElasticSearch plugins like <a href="https://www.elastic.co/guide/en/marvel/current/index.html">Marvel</a> and <a href="https://mobz.github.io/elasticsearch-head/">Head</a>.</p>

<p>The Terraform configuration is as follows:  </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;elasticsearch&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;ElasticSearch Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 9400</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.elasticsearch_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 9400</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;ElasticSearch Node&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;elasticsearch_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-elb-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;ElasticSearch Elastic Load Balancer Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;ElasticSearch Load Balancer&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_elb&quot; &quot;elasticsearch_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-elb&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">subnets = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.elasticsearch_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cross_zone_load_balancing = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_draining = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">internal = true</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthy_threshold   = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">unhealthy_threshold = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval            = 10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">target              = &quot;TCP:9200&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout             = 5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_autoscaling_group&quot; &quot;elasticsearch_autoscale_group&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-autoscale-group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">availability_zones = [&quot;${aws_subnet.primary-private.availability_zone}&quot;,&quot;${aws_subnet.secondary-private.availability_zone}&quot;,&quot;${aws_subnet.tertiary-private.availability_zone}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_zone_identifier = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">launch_configuration = &quot;${aws_launch_configuration.elasticsearch_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">min_size = 3</span>
</span><span class='line'>  <span class="l-Scalar-Plain">max_size = 100</span>
</span><span class='line'>  <span class="l-Scalar-Plain">desired = 3</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_grace_period = &quot;900&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_type = &quot;EC2&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">load_balancers = [&quot;${aws_elb.elasticsearch_elb.name}&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;Name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;elasticsearch&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;role&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;elasticsearch&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${aws_elb.elasticsearch_elb.name}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_region&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${var.aws_region}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_launch_configuration&quot; &quot;elasticsearch_launch_config&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image_id = &quot;${var.elasticsearch_ami_id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">instance_type = &quot;${var.elasticsearch_instance_type}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">iam_instance_profile = &quot;app-server&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">key_name = &quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.elasticsearch.id}&quot;,&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enable_monitoring = false</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">lifecycle {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">create_before_destroy = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">root_block_device {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volume_size = &quot;${var.elasticsearch_volume_size}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This allows me to scale my system up or down just by changing the values in my Terraform configuration. When the instances are instantiatied, the ElasticSearch cloud plugin discovers the other members of the cluster and allows the node to join the cluster</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Autoscaling Group Notifications with Terraform and AWS Lambda]]></title>
    <link href="http://www.paulstack.co.uk/blog/2015/12/30/autoscaling-group-notifications-with-terraform-and-aws-lambda/"/>
    <updated>2015-12-30T13:51:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2015/12/30/autoscaling-group-notifications-with-terraform-and-aws-lambda</id>
    <content type="html"><![CDATA[<p>I use Autoscaling Groups in AWS for all of my systems. The main benefit for me here was to make sure that when a node died in AWS, the Autoscaling Group policy made sure that the node was replaced. I wanted to get some visibility of when the Autoscaling Group was launching and terminating nodes and decided that posting notifications to <a href="https://slack.com/">Slack</a> would be a good way of getting this. With <a href="https://terraform.io/">Terraform</a> and <a href="http://docs.aws.amazon.com/lambda/latest/dg/welcome.html">AWS Lambda</a>, I was able to make this happen.</p>

<p><strong>This post assumes that you are already setup and running with Terraform</strong></p>

<p>Create an IAM Role that allows access to AWS Lambda:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_role" "slack_iam_lambda" {
</span><span class='line'>    name = "slack-iam-lambda"
</span><span class='line'>    assume_role_policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>  "Version": "2012-10-17",
</span><span class='line'>  "Statement": [
</span><span class='line'>    {
</span><span class='line'>      "Action": "sts:AssumeRole",
</span><span class='line'>      "Principal": {
</span><span class='line'>        "Service": "lambda.amazonaws.com"
</span><span class='line'>      },
</span><span class='line'>      "Effect": "Allow",
</span><span class='line'>      "Sid": ""
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>Create a <a href="GIST%20GOES%20HERE">lambda function</a> as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_lambda_function" "slack_notify" {
</span><span class='line'>  filename = "slackNotify.zip"
</span><span class='line'>  function_name = "slackNotify"
</span><span class='line'>  role = "${aws_iam_role.slack_iam_lambda.arn}"
</span><span class='line'>  handler = "slackNotify.handler"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>We assume here, that you have already created a Slack Integration. The hook URL from that integration is required for the lambda contents. </p>

<p>The filename <code>slackNotify.zip</code> is a zip of a file called <code>slackNotify.js</code>. The contents of that js file are <a href="https://gist.github.com/stack72/ad97da2df376754e413a">available</a></p>

<p>Terraform currently does not support hooking AWS Lambda up to SNS Event Sources. Therefore, unfortunately, there is a manual step required to configure the Lambda to talk to the SNS Topic. There is a PR in Terraform to allow this to be automated as well.</p>

<p>In the AWS Console, go to Lambda and then chose the Lambda function. </p>

<p><img src="http://www.paulstack.co.uk/images/lambda_function.png" alt="Image"></p>

<p>Go to the <code>Event Sources</code> tab:</p>

<p><img src="http://www.paulstack.co.uk/images/lambda_function_event_sources.png" alt="Image"></p>

<p>Click on <code>Add Event Source</code> and then choose <code>SNS</code> from the dropdown and then make sure you chose the correct SNS Topic name:</p>

<p><img src="http://www.paulstack.co.uk/images/lambda_function_sns_topic.png" alt="Image"></p>

<p>We then use another Terraform resource to attach the Autoscale Groups to the Lambda as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_autoscaling_notification" "slack_notifications" {
</span><span class='line'>  group_names = [
</span><span class='line'>    "admin-api-autoscale-group",
</span><span class='line'>    "rundeck-autoscale-group",
</span><span class='line'>  ]
</span><span class='line'>  notifications  = [
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE_ERROR",
</span><span class='line'>    "autoscaling:TEST_NOTIFICATION"
</span><span class='line'>  ]
</span><span class='line'>  topic_arn = "${aws_sns_topic.asg_slack_notifications.arn}"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>As we have configured notifications for autoscaling:TEST_NOTIFICATION, when you apply this configuration with Terraform, you will see something similar to the following in Slack:</p>

<p><img src="http://www.paulstack.co.uk/images/slack_test_notification.png" alt="Image"></p>

<p>In the current infrastructure I manage, there are 27 Autoscale groups. I don&#39;t really want to add 27 hardcoded group<em>names in the aws</em>autoscaling_notifcation in Terraform. </p>

<p>I wanted to take advantage of a <a href="https://www.terraform.io/docs/modules/usage.html">Terraform module</a>. In a nutshell, the module does a lookup of all the Autoscaling Groups in a region and then passes that list into the Terraform resource.</p>

<p>The output of the <a href="https://github.com/stack72/tf_aws_autoscalegroup_names">module</a> looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "variable": {
</span><span class='line'>    "autoscalegroup_names": {
</span><span class='line'>      "description": "List of autoscalegroup names for a region",
</span><span class='line'>      "default": {
</span><span class='line'>        "eu-west-1": "admin-api-autoscale-group,dash-autoscale-group,demo-autoscale-group,docker-v2-autoscale-group,elasticsearch-autoscale-group,faces-autoscale-group,internal-api-autoscale-group,jenkins-master-autoscale-group,kafka-autoscale-group,landscapes-autoscale-group",
</span><span class='line'>        "ap-southeast-1": "",
</span><span class='line'>        "ap-southeast-2": "",
</span><span class='line'>        "eu-central-1": "",
</span><span class='line'>        "ap-northeast-1": "",
</span><span class='line'>        "us-east-1": "",
</span><span class='line'>        "sa-east-1": "",
</span><span class='line'>        "us-west-1": "",
</span><span class='line'>        "us-west-2": ""
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>I then pass this into the Terraform resource as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module "autoscalegroups" {
</span><span class='line'>  source = "github.com/stack72/tf_aws_autoscalegroup_names"
</span><span class='line'>  region = "${var.aws_region}"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_autoscaling_notification" "slack_notifications" {
</span><span class='line'>  group_names = [
</span><span class='line'>    "${split(",", module.autoscalegroups.asg_names)}",
</span><span class='line'>  ]
</span><span class='line'>  notifications  = [
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE_ERROR",
</span><span class='line'>    "autoscaling:TEST_NOTIFICATION"
</span><span class='line'>  ]
</span><span class='line'>  topic_arn = "${aws_sns_topic.asg_slack_notifications.arn}"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>When anything happens within an Autoscaling Group, I now get notifications as follows:</p>

<p><img src="http://www.paulstack.co.uk/images/termination_notification.png" alt="Image">
<img src="http://www.paulstack.co.uk/images/launch_notification.png" alt="Image"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Quest for Infrastructure Management 2.0]]></title>
    <link href="http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/"/>
    <updated>2015-11-09T10:50:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0</id>
    <content type="html"><![CDATA[<p>I&#39;ve long been a configuration management tool fan. I have blogged, spoken at conferences and used <a href="https://puppetlabs.com/">Puppet</a> as well as <a href="https://www.chef.io/">Chef</a> and <a href="http://www.ansible.com/">Ansible</a>. The more I use these tools now, the more I realise I&#39;m actually not making my life any easier</p>

<p>Currently, the infrastructure I manage is 100% AWS Cloud based. This has actually changed how I work:</p>

<ol>
<li><p>I have learned to always expect problems so I therefore should have <em>everything</em> 100% automated.</p></li>
<li><p>No server is kept in production for more than 2 weeks</p></li>
</ol>

<p>By combining these 2 ways of working, I can easily recover from outages. The speed of recovery is down to being able to provision the pieces of my system as fast as possible. The simplist way to be able to provision instances fast is to build my own AMIs with <a href="https://packer.io/">Packer</a>. I have come to the realisation that when I boot an instance, I don&#39;t <em>really</em> want to wait for a configuration management tool to run. I have also begun to realise that having a tool change my systems in production can introduce unneeded risk. The Packer templates to build the AMI have <a href="http://serverspec.org/">serverspec</a> tests built into them. This means that at build time, I know if an AMI has been built correctly.</p>

<p>The AWS infrastructure itself is managed by <a href="https://terraform.io/">Terraform</a>. I tend to use AutoScalingGroups and LaunchConfig for the instances and when Terraform is checking the state of the infrastructure, it will look up the latest AMI ID and make sure that it is part of the Launch Configuration. If it isn&#39;t, Terraform will update the Launch Config so that the next machine will be booted from the new AMI.</p>

<p>I use <a href="http://rundeck.org/">Rundeck</a> for orchestrating changes to the infrastructure. I have a job in Rundeck that allows me to recycle <em>all</em> instances in an AutoScalingGroup one at a time and in a HA manner. From building a new AMI, to fully recycling an AutoScalingGroup is about 20 minutes (the packer build itself takes about 12 minutes). So, in theory, it takes me about 20 minutes to release new security patches to all instances in an AutoScalingGroup.</p>

<h3>Isn&#39;t this just &#39;Golden Images&#39;?</h3>

<p>Technically, yes. But the important for me is being able to roll out a fully tested AMI and then not making any additional changes to it in production. I would like to say that my infrastructure is 100% immutable, but after reading a <a href="https://medium.com/@elijahz/what-version-is-your-infrastructure-3a61fe804d0e">recent article</a> by <a href="https://twitter.com/emmajanehw">@emmajanehw</a>, I now realise that can never be the case. Each of my AMIs are versioned and I have a nightly Rundeck job that tells me what version of an AMI a system is built / released with.</p>

<h3>Do I Consider Configuration Management Dead?</h3>

<p>Not at all. I simply do not want to make additional changes to my environments when I know they are working. Right now, I use Ansible to provision my AMI as part of my Packer scripts. So I do believe these tools still need to be part of our eco-system. I could substitute in any configuration management tool to help build my AMIs. The purists could even use bash / shell scripts to do the same job</p>

<h3>Can I only do this if I use *nix / AWS?</h3>

<p>Not at all. At $JOB[-1], we actually were changing our provisioning to allow us to spin up images much faster. We were using a mix of AMIs and VMWare templates for Windows and Ubuntu. By moving in that direction, it would reduce the time taken to provision a box from maybe an hour to minutes.</p>

<p>In my opinion, moving to a more immutable style of infrastructure is the next phase of infra management for me. I believe the learnings from using config management tools in production across 1000s of nodes has helped me move in this direction but YMMV.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[DevOps and .Net Conference]]></title>
    <link href="http://www.paulstack.co.uk/blog/2015/10/28/devops-and-net-conference/"/>
    <updated>2015-10-28T12:29:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2015/10/28/devops-and-net-conference</id>
    <content type="html"><![CDATA[<p>So I just tweeted the following,</p>

<p><img src="http://www.paulstack.co.uk/images/DevOpsTweet.png" alt="Image"></p>

<p>Firstly, I&#39;d like to say that this is <em>not</em> about naming and shaming. Secondly, I am not annoyed with the conference at all about the response. The conference I spoke to advertises itself as “engineering talks only” so I wanted to post a few things about that.</p>

<p>In my opinion, the writing of code and the ecosystem of a specific platform is only 10% (or rather a small portion) of what we need to be aware of as software engineers. I am a software developer who works in the infrastructure / ops world now. When I was writing application only code, I was not involved in understanding the entire ecosystem of the software I was working on. In hindsight, I really feel I missed out by not being part of it. Since being part of the infrastructure world, I feel it has actually helped me develop better &amp; more robust software.</p>

<p>Organising conferences is a huge amount of work and is, frankly, hard. I understand that conferences cannot cater for every part of an ecosystem. One thing I do think conferences should do, is to strive to make developers better. DevOps, Continuous Delivery and Infrastructure are / should be things that we, as developers, care about. To dismiss these style of topics from a conference that advertises for “engineering talks only” can help to hinder developers from delivering the best products they can. It may not also make developers understand the importance of software being in production and making money</p>

<p>Food for thought…</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Recommended Ops Books]]></title>
    <link href="http://www.paulstack.co.uk/blog/2015/04/09/recommended-ops-books/"/>
    <updated>2015-04-09T10:50:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2015/04/09/recommended-ops-books</id>
    <content type="html"><![CDATA[<p>I created a Github repo to store all the book recommendations I have had since moving more into the operations space. The book categories (so far), include:</p>

<ul>
<li>DevOps / Culture</li>
<li>Continuous Delivery</li>
<li>Systems Thinking</li>
<li>Web Operations</li>
<li>System Architecture</li>
<li>Tooling</li>
</ul>

<p>I want this repository to continue to grow with a list of links to books that people would recommend. If you feel you want to make some recommendations, then please feel free to send a PR!</p>

<p>Otherwise, enjoy the <a href="https://github.com/stack72/ops-books">suggestions</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Looking for a new role]]></title>
    <link href="http://www.paulstack.co.uk/blog/2015/03/04/looking-for-a-new-role/"/>
    <updated>2015-03-04T14:20:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2015/03/04/looking-for-a-new-role</id>
    <content type="html"><![CDATA[<p>EDIT: I am no longer looking for a new role. Thanks to all for the suggestions</p>

<p>TL;DR: I am looking for a new role. I am an infrastructure developer who has a passion for metrics, monitoring and alerting. If you feel that you are interested in me coming to help your engineering team, then get in contact with me</p>

<p><a href="public@paulstack.co.uk">public@paulstack.co.uk</a></p>

<h3>I love working on infrastructure!</h3>

<p>Over the past few years, I have helped transform a team who worked solely in the manual sysadmin space into the configuration management world. This has reduced the time taken to provision a server and get an application into production from a number of weeks, to a number of hours.</p>

<p>Metrics are a key part of my day to day work. I believe that if we don&#39;t measure it then we cannot improve on it and learn from it. I also love to know what is happening with my systems before getting a call from an end user telling me there is a problem.</p>

<p>I have a real drive to make the lives of the engineer teams I work with easier. This means that by helping to create better infrastructure practices, I am helping them and ultimately helping deliver more business value</p>

<h3>What type of company would I work for?</h3>

<p>I have learned over the past few years that being part of a good company is the key to a happy work life. Culture, to me, is absolutely everything. I deeply care about what I do and I really want to be part of a company that holds these same values.</p>

<p>Remote work is something I am interested in, as long as the company is set up for it. I worked remotely a lot in 2014 and found it to be hugely productive as well as beneficial for my previous company because it allowed me to interact to a greater scale with the wider engineer community learning and sharing best practices to keep at the forefront of the industry. I therefore don’t mind where in the world a company is based, but that company must value treating remote employees as importantly as those who are office based</p>

<h3>What about the role?</h3>

<p>I want to be part of a team that care about the systems they create. Working on challenging problems brings out the absolute best in me, and being successful in this means the team I belong to is hugely important because every single person has a role to play in finding and implementing solutions. Working with a team of engineers who always want to improve themselves, their work, and support their colleagues, is what drives me and helps create a supportive team dynamic. Therefore I want to work with engineers who have a good work/life balance and love what they do as much as I do.</p>

<h3>What I definitely don&#39;t want to do</h3>

<p>I don&#39;t want to be a ticket filler. I want to be involved in helping to shape infrastructure systems and helping to drive decisions going forward. In my opinion, automation is key to helping deliver great systems and I really want to be part of delivering those systems</p>

<h3>So hire me!</h3>

<p>If your company is looking for passionate infrastructure developers who always want to improve or If your company has a need (and the willingness) to drive their infrastructure forward and improve then I could be the right person for you. </p>

<p><a href="public@paulstack.co.uk">public@paulstack.co.uk</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[IT Recruitment is F**ked]]></title>
    <link href="http://www.paulstack.co.uk/blog/2014/01/28/it-recruitment-is-f-star-star-ked/"/>
    <updated>2014-01-28T18:12:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2014/01/28/it-recruitment-is-f-star-star-ked</id>
    <content type="html"><![CDATA[<p>We get inundated with job specs in our inbox. Each email is filled with buzzwords in order to try and entice us to take the new role. I have not, nor will not, take a job spec filled with buzzwords. I join a company because of a culture. Having recently read Simon Sinek&#39;s book, <a href="http://www.amazon.com/Start-Why-Leaders-Inspire-Everyone/dp/1591846447">Start With Why</a>, I really started to see how recruitment in IT is ~~f**ked~~ broken. The book talks about manipulations in modern society. This sounds bad and that it&#39;s not something we are used to. It&#39;s something we are very used to. We see it everyday. Supermarkets offering &#39;buy 1 get 1 free&#39; on products. Car companies offering us &#39;£500 cashback&#39; when buying a new car. This is all manipulation to get us to buy things. How many of us have bought a second item at the supermarket as it is buy 1 get 1 half price? </p>

<p>IT recruitment also has a lot of manipulation in it. In the past, I applied for a job by giving my details to a recruiter. I have turned up for that specific interview to find I was interviewing for a job I didn&#39;t know about. A job I had no experience for. My CV had been changed to fit the spec the company had asked for. The recruiter was manipulating the company to get someone in the door. These types of things happen every day. I get emails in my inbox offering me &#39;John Smith&#39; at £250 a day. I am not a recruitment manager and I have never spoken to these companies. They are effectively fishing. Would you be happy knowing you are being used as a carrott for a recruitment company to get into a company?</p>

<p>It is because of this that I have a mistrust in most recruiters. Not all are bad. It feels as thought they manipulate us (companies) into working with them. I understand they are just trying to do their job. I just try not to use them. I would rather hire someone based on a referral from someone else. But even that can have manipulations to it though. How many of you get a referral bonus for bringing someone to your company? Are we doing it for the right reasons? I like to think I am and not for money</p>

<p>Consider the following, fake, job spec:</p>

<hr>

<p><strong>Job Description:</strong><br>
Do you have strong experience in X and Y technologies? Are you interested in joining a strong team who do A, B and C?</p>

<p><strong>Skills &amp; Requirements:</strong><br>
* 5 years experience in X<br>
* Deep understanding of Agile<br>
* 3 years experience in a technology only released this year<br>
* Buzzword 1<br>
* Buzzword 2<br>
* etc.</p>

<p>If interested, then please contact, me@buzzwordrecruiter.co.uk </p>

<hr>

<p>This doesn&#39;t interest me in the slightest. I have no feel about what type of work I&#39;d be doing or who I&#39;d be working with. It stipulates the technologies I&#39;d be using to try and eliminate people up front.It doesn&#39;t tell me anything about the company or what they are trying to achieve. This type of advert is <strong>never</strong> going to entice me to join this company. I mentioned above that I would only join companies now because of culture. Culture is very important to me. I need to be working with smart people who challenge me or I get bored. I don&#39;t want to be bored. </p>

<p>In the book Start With Why, Simon Sinek continually reiterates &#39;people don&#39;t buy what you do, they buy why you do it&#39;. The example advert, above, would be from a company who can&#39;t sell why they do something. Maybe there don&#39;t understand it themselves. Not many companies can sell their &#39;Why&#39;. A few companies I know can do this are <a href="http://www.etsy.com/">Etsy</a>, <a href="http://tretton37.com/">Tretton37</a> and <a href="http://www.github.com/">Github</a>. The structure of a job spec from Etsy starts as follows:</p>

<p><strong>We build tools that enable our engineering team to safely deploy code to the Etsy website. These include the Continuous Integration (CI) system, xUnit frameworks, and functional testing suites. Everyone in the Product and Engineering teams can deploy code into production, on their own. We do this over 30 times every day. Release management is a role in which everyone on the team plays an active part, starting on their first day of work</strong></p>

<p>Straight away, before I read more than 1 paragraph, I understand what the values of their engineering team is. They then go on to talk about the team:</p>

<p><strong>The technical staff at Etsy believes that code is craft, good software and systems designs are works of art, and that the work we do is part of larger creative culture represented by the hundreds of thousands of inspired makers who make Etsy such a wondrous marketplace</strong></p>

<p>This helps solidify the culture they are telling me about and the engineers they hire to make this happen. They go on to say the following:</p>

<p><strong>Our current systems run PHP, Java, Python, Ruby, Solr/Lucene, Postgres, MySQL, and more.</strong></p>

<p>I could go on with the advert. It summed up the perfect job advertisement for me. This is the type of advert that would really get me interested in a job. I would join them for that culture. It isn&#39;t a job spec, it is an introduction to life at Etsy. </p>

<p>Are skills / technologies the most important thing to me when I hire someone? I used to think so. But now, it really isn&#39;t. If someone doesnt have passion or buy into the same values my company does then all the skills in the world may not help me fit in and work well. Skills can be taught. Communications, culture and passion can&#39;t (in my opinion). </p>

<p>It is important to say that not 100% of blame sits with recruiters. Companies, themselves, need to be much better towards their employees. After reading <a href="http://37signals.com/remote/">Remote</a>, the 37 signals book, I really started to see how somethings are being missed by companies themselves. Remote working is definitely 1 of them. I was never a fan of remote working. I would not want a remote worker in my team, until I started travelling a lot for work. Being remote from my team has really get better at communication and focus. I often will go to a conference and work remotely now. I am actually quite productive. I am writing this blog post on an 11 hour flight :). </p>

<p>To me, I don&#39;t think we, as compnaies, should care where you are based. We should allow our team members to work where they are most productive - if that happens to be in their home in the Swiss Alps then so be it. I understand there are legal hurdles when hiring remote workers. These are not insurmountable. It&#39;s important to say that companies like Github and Etsy have staff all over the world. American companies with staff in UK, Australia, New Zealand etc. Nothing is impossible.</p>

<p>Staff benefits are another piece of the puzzle required to help recruit people. Too many job specs say things like &#39;subsidised gym membership&#39; or &#39;healthcare&#39; included. What if I have my own gym membership or my own private healtcare? Can&#39;t I choose something else to help me during my time at that company? Again, the Remote book helped me to see that this is important. At 37 signals, staff are offered a family holiday or cooking school experience etc. This becomes part of their benefits package. That is much more useful to someone who has healthcare and gym membership already. It also helps the employee feel really valued</p>

<p>Everything I write about here is the result of creating a good culture and a sense of understanding of Why we do things rather than what we do. Culture is a tough thing to breed but when you do get there it seems as though it&#39;s really worth it. We need to keep hiring people to vreed that culture, people who buy into it. It&#39;s 2014, we should be better at hiring people. There are a lot of skilled people out there - it&#39;s time to tap into that resource pool. It can help you create truly special products. Look to companies like Etsy, Github, Netflix, Puppetlabs etc. for inspiration on what we can do better in this space.</p>

<p>$0.02</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Can we fully trust online training courses?]]></title>
    <link href="http://www.paulstack.co.uk/blog/2014/01/11/can-we-fully-trust-online-training_courses/"/>
    <updated>2014-01-11T21:11:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2014/01/11/can-we-fully-trust-online-training_courses</id>
    <content type="html"><![CDATA[<p><em>NOTICE: This post is not written to pick on any specific person or service. This is only my thoughts from speaking to people in the past few weeks</em></p>

<p>The online training industry seems to be a lucrative thing. I have heard rumours (unconfirmed! ) of authors earning 6 or 7 figure sums from training courses they have made and delivered. While part of me thinks, &quot;I really want a part of that&quot;, the other part of me thinks that I don&#39;t have the level of expertise to do it.</p>

<p>I (used to) blog a lot. I speak at a lot of conferences. I have even been known to ramble on a podcast or a screencast. In my opinion, I suggest others get involved in doing things like this. It creates a culture of sharing and exchanging information. I don&#39;t earn money for these activities. I feel like I can talk about what I am passionate about. I also feel as though I can talk about new things.</p>

<p>I also run training courses on continuous integration and delivery. I am paid for these. Since I am paid for these, I feel that the level of information I put into these courses needs to create value for the attendees. In order to deliver information that is useful, I <strong>really</strong> need to understand my subject matter. By no means do I consider myself an expert in continuous integration or continuous delivery. I do feel as though I have enough experience building these systems that I can pass my learnings off to other users.</p>

<p>The courses that I run are very much face to face. I listen to the attendees to see what they want to achieve and I tailor the content to give them that information. Online training courses do not do this, in my opinion. I have considered trying to record some material but I don&#39;t know if the information would be of use. My pet hate is when people record training material on subjects that they know very little about or have little understanding about.</p>

<p>I have seen places where individual people record lots and lots of courses. Of course, they get paid to do this. To me, this feels wrong. What gives those authors the right to disseminate information on a topic that they don&#39;t have a deep understanding of? The information they give may not be accurate - does the user get their money back if they watch a video on API design, follow it and causes a production outage?</p>

<p>Is the issue with the authors themselves or the training companies?</p>

<p>The same issue happens with books. I reviewed a lot of books in 2013. A lot of the books were excellent. Some of them were not very good at all. Book publishers are spamming potential authors trying to get them to write. This is a source of income for them (albet it low). But it&#39;s extra income all the same.</p>

<p>In my opinion, publishers have a contract with people who use their services. Get the best possible trainers for the subject. Don&#39;t put metrics above the level of service you give to your customers. Good training makes us all better at what we do. It&#39;s important we don&#39;t give developers / operations / managers a false understanding of topics. It can cause issues in a team and it can cause issues in our systems. I&#39;m not looking to name and shame people / companies here but I do expect a good level of service if I pay for something</p>

<p>&lt;/rant&gt;</p>

<p>I just learned that <a href="https://twitter.com/hhariri">Hadi Hariri</a> wrote a post on the <a href="http://hadihariri.com/2012/03/18/the-journey-of-teaching/">Journey of Teaching</a>.</p>

<p>Thanks to <a href="https://twitter.com/thefringeninja">thefringeninja</a> for making sure this wasn&#39;t too ranty :)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Changing my focus]]></title>
    <link href="http://www.paulstack.co.uk/blog/2014/01/09/changing-my-focus/"/>
    <updated>2014-01-09T10:11:00+00:00</updated>
    <id>http://www.paulstack.co.uk/blog/2014/01/09/changing-my-focus</id>
    <content type="html"><![CDATA[<p>For those that know me, you know that I am very passionate about infrastructure and DevOps. Infrastructure is something that we, as developers, don&#39;t really give a lot of thought to. DevOps is something that will make our businesses more successful. So, I am changing the job role that I have. </p>

<p>From now, I am no longer focusing on writing application code. Instead I am going to spend my time focusing on the following areas:</p>

<ul>
<li>Be the facilitator to help our engineering team be much better by creating a DevOps culture</li>
<li>Writing code to control our infrastructure</li>
<li>Learning about the weird and wonderful ways of operations</li>
</ul>

<p>DevOps is very important to me. When a company has a great culture, things get done. Operations work is smooth, software delivery is smooth and the teams are truly focused on achieving the goals of the business. Without a DevOps culture, things are not as smooth as they could be. In order to allow our developers to more faster, we will be building better systems (e.g. provisioning, configuration management, monitoring, logging etc.) to allow them to really achieve &#39;situational awareness&#39;</p>

<p>I heard the term &#39;situational awareness&#39; just over a year ago. It was defined as &#39;knowing what is going on around you&#39;. Putting this into context, do you know what is going on with your applications in production? I certainly didn&#39;t. This is essential to understand how your software is performing. I will be trying to help our engineers to try and solve this issue by helping them build better infrastructure management systems.</p>

<p>Operations is something that I know very little about. By exposing myself to this world, I feel it will help me understand the continual frustrations that operations and development staff have towards each other. </p>

<p>As you can see, I am truly trying to be a DevOps advocate. I want to be the person that helps the teams talk to each other and help each other rather than (traditionally) having silos. I will still be trying to talk at developer events / conferences. I feel that I can really help developers understand more about DevOps and how it can be successful. </p>

<p>This is a very exciting change for me! Let&#39;s see how it goes&#8230;.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why delay the VS2012 release, Microsoft?]]></title>
    <link href="http://www.paulstack.co.uk/blog/2012/08/09/why-delay-the-vs2012-release-microsoft/"/>
    <updated>2012-08-09T00:00:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2012/08/09/why-delay-the-vs2012-release-microsoft</id>
    <content type="html"><![CDATA[<p>The date is 1st August 2012. Developers have been wondering for weeks when the release of VS2012 and ASP.NET 4.5 will happen. Somasegar, cvp of dev div in Microsoft, has just <a href="http://blogs.msdn.com/b/somasegar/archive/2012/08/01/visual-studio-2012-and-net-4-5-complete.aspx" target="_blank">announced that the final build version of VS2012 is complete</a>.This means the product is ready for release. Dot net developers all over the world are eagerly waiting for the immortal words, &ldquo;it&rsquo;s available to download on MSDN&rdquo;. Unfortunately they haven&rsquo;t come. Instead, the download will not show up for another 14 days. This seems wasteful to me.</p>
<p>Tell me if I am incorrect, but I believe the delay is that the product has gone to tool vendors to make sure that their tools / plugins will work with the application. This to me seems a very strange thing to do. This product has technically been in the making for 18 months (since the release of VS2010) so giving it to vendors in the final 2 weeks is crazy. What will happen if the vendors report it doesn&rsquo;t work with their tools? Would Microsoft stop a release for this considering it is so baked into the windows 8 release? I don&rsquo;t think there is any possibility of that happening at all. Therefore why the delay? I understand that 3rd party vendors are customers that Microsoft have to satisfy, but technically so are we &ndash; the users of the product.</p>
<p>My ethos on software delivery is ship early, ship often. I hate when a feature is complete that it has to wait around for 2 weeks before release. Get the product out there, start gathering feedback and get planning to deliver more value to that customer. I understand that VS2012 is not easy to release often. Its a rather large download and there are pricing models around it. But changing the shape of the product to delivery in small chunks that are updatable more often would allow the product to get shaped by its user base. Faster feedback means delivering more customer value. It seems that other departments within Microsoft are now following this model (MVC team, EF team and Nuget team). Delivering like this is becoming more popular (and hopefully will become the standard). Its time to embrace this ethos Microsoft. Its certainly how I would be looking at things in the future if I were the product lead developer.</p>
<p>$0.02</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Survival of the fittest – fluid teams?]]></title>
    <link href="http://www.paulstack.co.uk/blog/2012/06/25/survival-of-the-fittest-fluid-teams/"/>
    <updated>2012-06-25T00:00:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2012/06/25/survival-of-the-fittest-fluid-teams</id>
    <content type="html"><![CDATA[<p>In traditional, waterfall organisations, a development team follows the organisation hierarchy. The development team can be split into smaller sub teams and each of those teams can have their own leader, but ultimately the hierarchy still exists. Developers usually stay in that sub team for most of their time in the organisation and they know exactly who their line manger is and who is responsible for their reviews and can act accordingly. The organisational structure is rigid and embedded into the process of the team and organisation.</p>
<p>In more agile teams, the organisational structure is less rigid meaning that developers do not need to stay in a single sub team for their time at the company. They can be organised (or organise themselves in more advanced agile cultures) into teams based on skills. New developers are hired with a view to how they can benefit the wider team and not towards the skills needed for a sub team in a waterfall environment. Even though there are less restrictions on people moving between teams, it is not always guaranteed. It can happen when required, e.g. when a new member of staff is hired and the skillsets need to be spread evenly. This can evolve further.</p>
<h4>Can agile teams be formed around projects?</h4>
<p>Simply, yes. This is actually how projects work at Facebook. When a developer joins the company, they can request what team they want to join when their &lsquo;boot camp&rsquo; is over. Each developer has a desk and that desk is on wheels. Their office is completely open plan. When a team&rsquo;s project is finished, the developers simply break up as a unit and wheel their desks to form the next team for the next project.</p>
<p>I&rsquo;ve talked to a few people about this fluid team structure. All responses seem to follow the questions:</p>
<ul>
<li>If a developer continually moves around, who is the manager responsible for the developers review?</li>
</ul>
<p>At school, I was part of a form group and I had a form tutor. This was the class I was part of each morning between 0900 and 0910 and where registration would be taken. I didn&rsquo;t study all my subjects with that class or that tutor. Each teacher had their own area of expertise. I moved around when I needed to go to a class. The same can happen in the workplace. In an agile team there should not be any need to micromanage members of the team. Just because you don&rsquo;t sit beside your line manager doesn&rsquo;t mean they cannot manage you. They need to form a trusting and communicative relationship with each other &ndash; characteristics of an agile team. This will allow the manager to know exactly how the developer is progressing and any obstacles in their way.</p>
<ul>
<li>What happens if a project ends up with all the weakest developers in a development department?</li>
</ul>
<p>If you are happy to hire weak developers then I suggest a look at your hiring process may be a useful thing to do. If a developer is not hired because they have the correct attitude, skillset and cultural fit for your team or you are happy to hire the &lsquo;best of a bad bunch&rsquo;&nbsp; then you may have bigger issues than worrying about the formation of sub teams.</p>
<p>To summarise, you don&rsquo;t need to keep developers locked to a team or a line manager. A trusting and communicative environment should always allow the team to focus on what they were hired for, the delivery of software. After all, if you are not here to care about the quality and standard of your work, then you should really think about changing career and stop wasting your employers money.</p>
<p>$0.02</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TFS and Continuous Deployment]]></title>
    <link href="http://www.paulstack.co.uk/blog/2012/06/19/tfs-and-continuous-deployment/"/>
    <updated>2012-06-19T00:00:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2012/06/19/tfs-and-continuous-deployment</id>
    <content type="html"><![CDATA[<p>I am a huge advocate of continuous integration and continuous delivery. I am always cautious about mentioning continuous deployment in my talks. This <strong>can</strong>, I stress the word can, be dangerous. For me there is a journey in the delivery of software.</p>  <ul>   <li>Companies, traditionally, started slow and go with manual deployments infrequently </li>    <li>Continuous Integration was introduced to the team when the team grew and needed to help test the integration of their code </li>    <li>The need to deploy more frequently may arise and as manual deployments are time consuming and (or) painful, deployments become automated </li>    <li>Continuous delivery was then said to be the better way to develop software (this meaning that code in the master repo is always in a state where it can be released to the end user) </li> </ul>  <p>This journey not only required a development teams skillset to grow to support it, but it also required a culture and attitude change as we move through the lifecycle. Developers need to start taking more care in their work and making sure that technical debt is not accrued too fast and that work is tested thoroughly. For me, when a team reaches this maturity point, they have reached the pinnacle of software delivery. The time required to release a new feature (cycle time) is determined by how fast the developer can develop and test the feature rather than worrying about release cycles. A release for this individual can be created and scheduled as appropriate to the needs of the business. The process is almost completely automated.</p>  <p>Lets take the step to continuous deployment. This is where every successful build is released to the end user. For me, things start to get a bit scary here. Continuous deployment is associated with start-ups. Companies that are releasing a new product and need to get it to market fast to get revenue and user feedback. As the codebase is young, it would has accrued less technical debt so the cycle time would potentially be faster than companies with legacy code. I believe that continuous deployment needs to be surrounded by rigorous automated testing (unit, integration, acceptance, system, performance etc..) and also supported by an immune system that helps to notify everyone if key performance or conversion metrics etc. drop below certain thresholds. This would help the confidence in the code being released to be as high as possible. In this type of environment, developers should work with the operations staff to make sure that deployments happen and follow up if there are issues with the release. I cannot stress enough that continuous deployment should not be taken lightly. It *will* come back and bit you on the ass if you are not well prepared.</p>  <p>Imagine my surprise when I read on twitter during the (azure announcement name hashtag) that the new version of TFS will support continuously deploying applications to the new azure portal [THIS NEEDS CHECKED FOR ACCURACY]. Firstly, I was surprised that this feature was added to TFS over something more useful, e.g. DVCS style version control. The lack of the good version control is a major downfall in TFS for me. Secondly, I think that this new feature will inspire a new breed of false bravery. I understand that it is very good to be brave. Nothing is braver than finishing development fast and pushing straight to production. There needs to be a process around these deployments – are they dark deployments, canary releases, have A/B testing etc.? Have you got the performance test analysis incase your feature causes an issue in production that costs the company money. Have you got monitoring around the system to spot potential issues early. There are many things I have set up around my continuous deployment sites.I don’t believe that all software developers give enough thought to what they are doing and will fix it later. Continuous deployment may not be good for these types of developer. A small issue unnoticed, e.g. a missing ‘checkout’ button on the site, can cause the company a lot of money. </p>  <p>I am by no way trying to say my setup is better than other developer setups, I am merely pointing out that a good support network around a deployment is needed. Maybe azure has this good support network but a developer should definitely know how to use it if they are to take advantage of this feature. If you are working on a personal project that doesn’t affect too much then continuously deploy until your heart is content. If wanting to take the giant leap to this in a company with legacy code then think twice. don’t f**k with your users. They potentially pay your salary. I think TFS should focus on making the tool easier to use for developers rather than worry about continuous deployment just yet</p>  <p>&lt;/TFSRant&gt;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[What is your interpretation of burnout?]]></title>
    <link href="http://www.paulstack.co.uk/blog/2012/06/07/what-is-your-interpretation-of-burnout/"/>
    <updated>2012-06-07T00:00:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2012/06/07/what-is-your-interpretation-of-burnout</id>
    <content type="html"><![CDATA[<p>I always had the idea that the term &lsquo;burnout&rsquo; had a pretty standard meaning in software development. I&rsquo;m sure each developer have their own way of phrasing it but in essence, I was always of the idea that it meant &lsquo;over working leading to exhaustion and lack of motivation&rsquo;.</p>
<p>I wanted to see what the exact thoughts of my peers was so asked on twitter &ldquo;what does burnout meant to you?&rdquo;. I got a list of varied responses:</p>
<p><a href="http://www.twitter.com/tomasmcguinness" target="_blank">@tomasmcguinness</a>: <em>Burnout in terms of software development? For me, it means losing the ability to concentrate and focus,combined with mental fatigue</em></p>
<p><a href="http://www.twitter.com/mbrit" target="_blank">@mbrit</a>: <em>For me, it&#8217;s about ending up at a dead end in terms of stimulation/career progress.</em></p>
<p><a href="http://www.twitter.com/kristofclaes" target="_blank">@kristofclaes</a>: <em>&#8220;I should have kept this as a hobby&#8230;&#8221; or something like that. Not sure how to put it into words.</em></p>
<p><a href="http://www.twitter.com/jcmm33" target="_blank">@jcmm33</a>: <em>whatever the cause, its a lack of focus/motivation/drive/engagement within an employee when there used to be</em></p>
<p><a href="http://www.twitter.com/nathangloyn" target="_blank">@NathanGloyn</a>: <em>burnout = not able to work any more, nervous breakdown, catastrophic event</em></p>
<p>These are only a few of the responses, but as you can see the vary a lot. The reason I asked this question is that whilst on a trip to San Francisco recently, I was able to catch a company organised talk from <a href="http://www.facebook.com/jayp" target="_blank">Jay Parikh</a>, the VP of Infrastructure at Facebook. I don&rsquo;t need to tell you who Facebook are therefore you can imagine I was very interested to hear his thoughts on the subject. Whilst talking to us, Jay spoke about Facebook hack-a-thons. Basically their entire team (product owners, devs, IT guys etc.) get together on a night of the week in the Facebook campus and work on something they don&#8217;t normally work on.</p>
<p>One of our developers asked the question, &ldquo;how do your devs avoid burnout when approaching hack-a-thons in the middle of a work week?&rdquo;. Jay discussed that development at Facebook wasn&rsquo;t a strict 9 &ndash; 5 culture and that developers would work the hours that they felt quite at home with. He said the developers at Facebook don&rsquo;t suffer burnout as <em>&ldquo;burnout is loosing interest in a project or piece of work&rdquo;</em> and their developers work for a maximum of 12 months in a team before moving to another.</p>
<p>I can see Jay&rsquo;s point but I don&rsquo;t feel that working too much and losing interest on a project are mutually exclusive. I think if you work too much then you can become bogged down in feeling a bit frustrated in your work. This can create boredom and make you lose interest and (or) focus. This is where I think burnout creeps in. This is what we need to make sure we avoid when we plan work. I usually associate burnout with long waterfall projects.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TeamCity - OutOfMemoryError]]></title>
    <link href="http://www.paulstack.co.uk/blog/2012/05/21/teamcity-outofmemoryerror/"/>
    <updated>2012-05-21T00:00:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2012/05/21/teamcity-outofmemoryerror</id>
    <content type="html"><![CDATA[<p>Whilst upgrading our TeamCity server from 6.5 to 7.x, I encountered an error:</p>
<p><em>Unexpected error occurred inside Alarm task: java.lang.OutOfMemoryError: GC overhead limit exceeded</em></p>
<p>After a bit of looking around and sifting through some very weird articles I was able to find some good information on this. Basically, the JVM starts by default with 512mb of memory and it was struggling to process our 300+ build configurations with this. In order to fix it I had to do the following:</p>
<ul>
<li>Go to TeamCity webserver</li>
<li>Open CMD</li>
<li>cd &lt;TeamCity root dir&gt;</li>
<li>cd bin</li>
<li>teamcity7w.exe //ES//TeamCity
<ul>
<li>If you are on TeamCity 6.x then you need to run teamcity6w.exe rather than ..7w</li>
</ul>
</li>
This will open the following dialog:</ul>
<p><a href="http://paulstack.co.uk/blog/images/image_51.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; margin-right: auto; padding-top: 0px; border: 0px;" title="image" src="http://paulstack.co.uk/blog/images/image_thumb_49.png" alt="image" width="244" height="233" border="0" /></a></p>
<p>Go to the Java tab and change the maximum memory pool entry to something other than 512mb</p>
<p align="center"><a href="http://paulstack.co.uk/blog/images/image_52.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; margin-right: auto; padding-top: 0px; border: 0px;" title="image" src="http://paulstack.co.uk/blog/images/image_thumb_50.png" alt="image" width="244" height="233" border="0" /></a></p>
<p>Restart the service and all should be well with the application start-up.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Introducing TeamCityMetro for WP7]]></title>
    <link href="http://www.paulstack.co.uk/blog/2012/05/17/introducing-teamcity-metro/"/>
    <updated>2012-05-17T00:00:00+01:00</updated>
    <id>http://www.paulstack.co.uk/blog/2012/05/17/introducing-teamcity-metro</id>
    <content type="html"><![CDATA[<p>After my foray into the work of the <a href="http://www.jetbrains.com/teamcity/" target="_blank">TeamCity</a> API, <a href="http://twitter.com/gep13" target="_blank">Gary Park</a> and I have written a WP7 app. We are pleased to announce that this app is now available in the <a href="http://stack72.me/teamcitymetrowp" target="_blank">AppStore</a> and is FREE to all. For version 1, the application will only give you the opportunity to see your projects, builds types, last 10 builds of each build type and then link to the build on your teamcity server. This is only an initial release and will be followed up with the ability to trigger builds.</p>
<p>The application looks as follows:</p>
<p align="center"><a href="http://paulstack.co.uk/blog/images/Screenshot1_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot1" src="http://paulstack.co.uk/blog/images/Screenshot1_thumb_1.png" alt="Screenshot1" width="148" height="244" border="0" /></a>&nbsp;<a href="http://paulstack.co.uk/blog/images/Screenshot2_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot2" src="http://paulstack.co.uk/blog/images/Screenshot2_thumb_1.png" alt="Screenshot2" width="148" height="244" border="0" /></a>&nbsp;<a href="http://paulstack.co.uk/blog/images/Screenshot3_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot3" src="http://paulstack.co.uk/blog/images/Screenshot3_thumb_1.png" alt="Screenshot3" width="148" height="244" border="0" /></a>&nbsp;<a href="http://paulstack.co.uk/blog/images/Screenshot4_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot4" src="http://paulstack.co.uk/blog/images/Screenshot4_thumb_1.png" alt="Screenshot4" width="148" height="244" border="0" /></a>&nbsp;<a href="http://paulstack.co.uk/blog/images/Screenshot5_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot5" src="http://paulstack.co.uk/blog/images/Screenshot5_thumb_1.png" alt="Screenshot5" width="148" height="244" border="0" /></a>&nbsp;<a href="http://paulstack.co.uk/blog/images/Screenshot6_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot6" src="http://paulstack.co.uk/blog/images/Screenshot6_thumb_1.png" alt="Screenshot6" width="148" height="244" border="0" /></a>&nbsp; <a href="http://paulstack.co.uk/blog/images/Screenshot7_1.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="Screenshot7" src="http://paulstack.co.uk/blog/images/Screenshot7_thumb_1.png" alt="Screenshot7" width="148" height="244" border="0" /></a></p>
<p>If you want to request a feature or leave us some feedback then please get in touch with us. An application website will soon appear. All feedback gratefully received. Huge thanks to all our beta testers. Without them this application would never have made it past beta.</p>
]]></content>
  </entry>
  
</feed>
