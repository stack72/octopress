---
layout: post
title: "Attribute Based Caching with PostSharp"
comments: true
---
<p>I&rsquo;ve been meaning to write this post for months now to talk about my work with PostSharp and Attribute Based Caching. PostSharp is an AOP tool &ndash; I won&rsquo;t get into too much detail about <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming" target="_blank">AOP</a> and <a href="http://www.sharpcrafters.com/" target="_blank">PostSharp</a> as I have provided links to them</p>
<p>I used PostSharp to remove the amount of code required for the caching of my calls in a legacy application. Traditionally I would have had to write code such as this:</p>
<p><a href="http://paulstack.co.uk/blog/images/image_21.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://paulstack.co.uk/blog/images/image_thumb_21.png" border="0" alt="image" width="609" height="259" /></a></p>
<p>I was able to change the way this was done with AOP. This makes the code snippet look as follows:</p>
<p><a href="http://paulstack.co.uk/blog/images/image_22.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://paulstack.co.uk/blog/images/image_thumb_22.png" border="0" alt="image" width="609" height="177" /></a></p>
<p>I have effectively removed 2 lines of code from EVERY method call and replaced it with an attribute over the method declaration. In order for this to build, I had to either install PostSharp or run it as an import target manually in my .csproj file. So what does the output of the IL look like when decompiled?</p>
<p><a href="http://paulstack.co.uk/blog/images/image_23.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://paulstack.co.uk/blog/images/image_thumb_23.png" border="0" alt="image" width="615" height="210" /></a></p>
<p>You can see that the IL has had Aspects added to it. The 3rd party dll I used (<a href="http://cache.codeplex.com/" target="_blank">CacheAspect</a>) then knows what to add to the code and this is then <a href="http://www.sharpcrafters.com/postsharp/documentation#under-the-hood" target="_blank">IL woven using PostSharp</a>. This means that the results of the MyMethod call will be added to the Cache with the key of StoredProcedureResults.</p>
<p>This has been majorly useful for me since I can invalidate the Cache on specific method calls</p>
<p><a href="http://paulstack.co.uk/blog/images/image_24.png"><img style="background-image: none; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="image" src="http://paulstack.co.uk/blog/images/image_thumb_24.png" border="0" alt="image" width="613" height="67" /></a></p>
<p>This method works by Invalidating the cache (key &ldquo;StoredProcedureResults&rdquo;) when the AddMethod is called. This scenario can be very useful when a list of users are cached and a new user is added to the list. It cuts down the code and is easy to read in my opinion.</p>
<p>I have posted before about how to hook <a href="http://paulstack.co.uk/blog/post/PostSharp-and-TeamCity-Integration.aspx" target="_blank">PostSharp up to my CI server</a>. AOP is not everyone's thing. It has been very useful for me on a small project. It has impacted the build time but I think its worth it for DRY code <img class="wlEmoticon wlEmoticon-smile" style="border-style: none;" src="http://paulstack.co.uk/blog/images/wlEmoticon-smile_6.png" alt="Smile" /></p>
