
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Adventures of a wannabe geek!</title>
  <meta name="author" content="Paul Stack (@stack72)">

  
  <meta name="description" content="The instances that run in my infrastructure get a lifespan of 14 days. This allows me to continually test that I can replace my environment at any &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.paulstack.co.uk">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Adventures of a wannabe geek!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-13083957-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Adventures of a wannabe geek!</a></h1>
  
    <h2>Ranting within</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.paulstack.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/contact">Contact Details</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/15/replacing-a-node-in-a-riak-cluster/">Replacing a Node in a Riak Cluster</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-15T11:03:00+00:00" pubdate data-updated="true">Jan 15<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The instances that run in my infrastructure get a lifespan of 14 days. This allows me to continually test that I can replace my environment at any point. People always ask me if I follow the same principal for data nodes. I posted <a href="http://www.paulstack.co.uk/blog/2016/01/04/replacing-the-nodes-in-an-aws-elasticsearch-cluster/">previously</a> about replacing nodes is an <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> cluster, this post will detail how I replace  nodes in a <a href="http://basho.com/products/riak-kv/">Riak</a> cluster </p>

<p><strong><em>NOTE</em></strong>: This post assumes that you have the <a href="http://docs.basho.com/riak/latest/ops/advanced/riak-control/*">Riak Control console</a> enabled for Riak. You can find out how to enable that in the <a href="http://www.paulstack.co.uk/blog/2016/01/06/building-a-riak-cluster-in-aws-with-packer-and-terraform/">post</a> I wrote on configuring Riak.</p>

<p>When going to the Riak Control, you can find the following screens:</p>

<p><em>Cluster Health</em></p>

<p><img src="/images/riak-control-cluster-health.png" alt="Image"></p>

<p><em>Ring Status</em></p>

<p><img src="/images/riak-control-ring-status.png" alt="Image"></p>

<p><em>Cluster Management</em> </p>

<p><img src="/images/riak-control-cluster-mgmt.png" alt="Image"></p>

<p><em>Node Management</em></p>

<p><img src="/images/riak-control-node-mgmt.png" alt="Image"></p>

<h3>Removing a node from the Cluster</h3>

<p>In order to remove a node from the cluster, go to the cluster managemenet screen. Find the node you want to replace in the list and click on the <code>Actions</code> toggle. It will reveal actions as follows:</p>

<p><img src="/images/riak-control-cluster-node-options.png" alt="Image"></p>

<p>As the node is currently running, I tend to chose the <code>Allow this node to leave normally</code> option (if the node had died or was unresponsive, I would usually chose the <code>force this node to leave</code>). Clicking on the <code>Stage</code> button, details a plan of what is going to happen:</p>

<p><img src="/images/riak-control-remove-node.png" alt="Image"></p>

<p>If the proposed changes look good, <code>Commit</code> the plan. Watch the partitions drain from the node to be replaced:</p>

<p><img src="/images/riak-control-node-draining.png" alt="Image"></p>

<p>When the all the partitions have drained, we now have a 2 node cluster where the partitons are split 50:50:</p>

<p><img src="/images/riak-control-smaller-cluster.png" alt="Image"></p>

<p>We can now destroy the node and let the <a href="https://aws.amazon.com/autoscaling/">autoscaling group</a> launch another to replace it</p>

<h3>Adding a new node to the Cluster</h3>

<p>Assuming a new node has already been launched and is ready to go into the cluster. Go to the cluster management page in the portal and enter new node details. It should follow the format <code>riak@&lt;ipaddress&gt;</code></p>

<p><img src="/images/riak-control-add-new-node.png" alt="Image"></p>

<p>The list of actions that are pending on the cluster:</p>

<p><img src="/images/riak-control-stage-new-node.png" alt="Image"></p>

<p><code>Commit</code> the changes, watch the partions rebalance across the cluster:</p>

<p><img src="/images/riak-control-cluster-rebalance.png" alt="Image"></p>

<p>The cluster will return to being 3 nodes, with equal partition split and will then show as green again</p>

<p><img src="/images/riak-control-green-cluster.png" alt="Image"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/06/building-a-riak-cluster-in-aws-with-packer-and-terraform/">Building a Riak Cluster in AWS With Packer and Terraform</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-06T15:02:00+00:00" pubdate data-updated="true">Jan 6<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following my <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">pattern</a> of building <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> for applications, I create my <a href="http://basho.com/products/riak-kv/">riak</a> cluster with <a href="https://packer.io/">Packer</a> for my AMI and <a href="https://terraform.io/">Terraform</a> for the infrastructure</p>

<h3>Building Riak AMIs with Packer</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Riak Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;riak-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;riak-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;riak.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>The install_dependencies.sh script is as described <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">previously</a></p>

<p>The ansible playbook for Riak looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">riak</span>
</span></code></pre></td></tr></table></div></figure>

<p>The playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install riak.</p>

<p>The riak ansible role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt_key url={{ riak_key_url }} state=present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt_repository repo=&#39;{{ riak_deb_repo }}&#39; state=present update_cache=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=riak={{ riak_version }} state=present update_cache=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">set ulimit</span>
</span><span class='line'>  <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=etc-default-riak dest=/etc/default/riak owner=root group=root mode=0644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">template riak configuration</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=riak.j2 dest=/etc/riak/riak.conf owner=riak mode=0644</span>
</span><span class='line'>  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart_riak</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart riak</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=riak state=started</span>
</span></code></pre></td></tr></table></div></figure>

<p>The role itself is very simple. The riak cluster settings are all held in the <a href="https://gist.github.com/stack72/e0df60305aff136cb81c">riak.j2</a> template file. Notice that the riak template has the following line in it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">riak_control = on</span>
</span></code></pre></td></tr></table></div></figure>

<p>The variables for the riak playbook look as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">riak_key_url</span><span class="p-Indicator">:</span> <span class="s">&quot;https://packagecloud.io/gpg.key&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">riak_deb_repo</span><span class="p-Indicator">:</span> <span class="s">&quot;deb</span><span class="nv"> </span><span class="s">https://packagecloud.io/basho/riak/ubuntu/</span><span class="nv"> </span><span class="s">trusty</span><span class="nv"> </span><span class="s">main&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">riak_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2.1.1-1</span>
</span></code></pre></td></tr></table></div></figure> 

<h3>Deploying Riak with Terraform</h3>

<p>The infrastructure of the Riak cluster is pretty simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_elb&quot; &quot;riak_v2_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-elb-v2&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">subnets = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.riak_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cross_zone_load_balancing = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_draining = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">internal = true</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthy_threshold   = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">unhealthy_threshold = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval            = 10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">target              = &quot;HTTP:8098/ping&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout             = 5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;riak&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Riak Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.riak_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Riak Node&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group_rule&quot; &quot;riak_all_tcp&quot; {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">type = &quot;ingress&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 0</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = 65535</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_group_id = &quot;${aws_security_group.riak.id}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">source_security_group_id = &quot;${aws_security_group.riak.id}&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;riak_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-elb-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Riak Elastic Load Balancer Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 8098</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Riak Load Balancer&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_autoscaling_group&quot; &quot;riak_v2_autoscale_group&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;riak-v2-autoscale-group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">availability_zones = [&quot;${aws_subnet.primary-private.availability_zone}&quot;,&quot;${aws_subnet.secondary-private.availability_zone}&quot;,&quot;${aws_subnet.tertiary-private.availability_zone}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_zone_identifier = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">launch_configuration = &quot;${aws_launch_configuration.riak_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">min_size = 0</span>
</span><span class='line'>  <span class="l-Scalar-Plain">max_size = 100</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_type = &quot;EC2&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;Name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;riak&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;role&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;riak&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${aws_elb.riak_v2_elb.name}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_region&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${var.aws_region}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_launch_configuration&quot; &quot;riak_launch_config&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image_id = &quot;${var.riak_ami_id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">instance_type = &quot;${var.riak_instance_type}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">iam_instance_profile = &quot;app-server&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">key_name = &quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.riak.id}&quot;,&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enable_monitoring = false</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">lifecycle {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">create_before_destroy = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">root_block_device {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volume_size = &quot;${var.driak_volume_size}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/04/replacing-the-nodes-in-an-aws-elasticsearch-cluster/">Replacing the Nodes in an AWS ElasticSearch Cluster</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-04T17:01:00+00:00" pubdate data-updated="true">Jan 4<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a <a href="http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">previous post</a>, I talked about how I have tended towards the philosophy of &#39;Immutable Infrastructure&#39;. As part of that philospohy, when a box is created in my environment, it has a lifespan of 14 days. On the 14th day, I get a notification to tell me that the box is due for renewal. When it comes to <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> nodes, there is a process I follow to renew a box. </p>

<p>I have an example 3 nodes cluster of ElasticSearch up and running to test this on:</p>

<p><img src="/images/aws_elasticsearch_cluster.png" alt="Image"></p>

<p>Let&#39;s assume that instance <em>i-</em> was due for renewal. Firstly, I would usually disable shard reallocation. This will stop unnecessary data transfer between nodes and minimise the wastage of I/O.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPUT localhost:9200/_cluster/settings -d '{
</span><span class='line'>                "transient" : {
</span><span class='line'>                    "cluster.routing.allocation.enable" : "none"
</span><span class='line'>                }
</span><span class='line'>        }'</span></code></pre></td></tr></table></div></figure>

<p>As these shard allocation is now disabled, I can continue with the node replacement. There are a few ways to do this. Previously to ElasticSearch 2.0, we could do it with the ElasticSearch API:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPOST 'http://localhost:9200/_cluster/nodes/MYNODEIP/_shutdown'</span></code></pre></td></tr></table></div></figure>

<p>If you are using ElasticSearch 2.0, you are more than likely running ElasticSearch as a service. To shutdown the node, stop the service.</p>

<p>By looking at the status of the cluster now, I can see the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "elasticsearch",
</span><span class='line'>  "status" : "yellow",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 2,
</span><span class='line'>  "number_of_data_nodes" : 2,
</span><span class='line'>  "active_primary_shards" : 160,
</span><span class='line'>  "active_shards" : 317,
</span><span class='line'>  "relocating_shards" : 0,
</span><span class='line'>  "initializing_shards" : 2,
</span><span class='line'>  "unassigned_shards" : 151,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>I can see that it tells me the cluster is yellow and that I have 2 nodes in it. I can proceed with the instance termination.</p>

<p><img src="/images/aws_elasticsearch_instance_terminated.png" alt="Image"></p>

<p>I have an AWS <a href="https://aws.amazon.com/autoscaling/">Autoscale Group</a> configured for ElasticSearch to keep 3 instances running. Therefore, the node that I destroyed will fail the Autoscale Group Healthcheck and a new instance will be spawned to replace it.</p>

<p>Using the ElasticSearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html">Cluster Health API</a>, I can determine when the new node is in place:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?wait_for_nodes=3&timeout=100s'</span></code></pre></td></tr></table></div></figure> 

<p>The command will continue running until the cluster has 3 nodes in it. If you want to replace more nodes in the cluster, then repeat the steps above. If you are finished, then it is important to re-enable the shard reallocation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XPUT localhost:9200/_cluster/settings -d '{
</span><span class='line'>                "transient" : {
</span><span class='line'>                    "cluster.routing.allocation.enable" : "all"
</span><span class='line'>                }
</span><span class='line'>        }'</span></code></pre></td></tr></table></div></figure>

<p>The time taken to rebalance the cluster will depend on the number and size of the shards.</p>

<p>You can monitor the health of the cluster until it turns green:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?wait_for_status=green&timeout=100s'</span></code></pre></td></tr></table></div></figure>

<p>The cluster is now green and all is working as expected again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -XGET 'http://localhost:9200/_cluster/health?pretty=true'
</span><span class='line'>{
</span><span class='line'>  "cluster_name" : "elasticsearch",
</span><span class='line'>  "status" : "green",
</span><span class='line'>  "timed_out" : false,
</span><span class='line'>  "number_of_nodes" : 3,
</span><span class='line'>  "number_of_data_nodes" : 3,
</span><span class='line'>  "active_primary_shards" : 160,
</span><span class='line'>  "active_shards" : 470,
</span><span class='line'>  "relocating_shards" : 1,
</span><span class='line'>  "initializing_shards" : 0,
</span><span class='line'>  "unassigned_shards" : 0,
</span><span class='line'>  "number_of_pending_tasks" : 0,
</span><span class='line'>  "number_of_in_flight_fetch" : 0
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/03/deploying-kibana-using-nginx-as-an-ssl-proxy/">Deploying Kibana Using Nginx as an SSL Proxy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-03T01:16:00+00:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my last <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">post</a>, I described how I use <a href="https://packer.io/">Packer</a> and <a href="https://terraform.io/">Terraform</a> to deploy an <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> cluster. In order to make the logs stored in ElasticSearch searchable, I use <a href="https://www.elastic.co/products/kibana">Kibana</a>. I follow the previous pattern and deploy Kibana using Packer to build an <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.htm">AMI</a> and then create the infrastructure using Terraform. The Packer template has already taken into account that I want to use <a href="https://www.nginx.com/">nginx</a> as a proxy. </p>

<h3>Building Kibana AMIs with Packer and Ansible</h3>

<p>The template looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Kibana Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;kibana-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;kibana-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;kibana.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
 

<p>The install_dependencies.sh script is as described <a href="http://www.paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">previously</a></p>

<p>The ansible playbook for Kibana looks as follows:  </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">kibana</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">reverse_proxied</span>
</span></code></pre></td></tr></table></div></figure>

<p>The playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install ElasticSearch.</p>

<p>The Kibana role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Download Kibana</span>
</span><span class='line'>  <span class="l-Scalar-Plain">get_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">url=https://download.elasticsearch.org/kibana/kibana/kibana-{{ kibana_version }}-linux-x64.tar.gz dest=/tmp/kibana-{{ kibana_version }}-linux-x64.tar.gz mode=0440</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Untar Kibana</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tar xzf /tmp/kibana-{{ kibana_version }}-linux-x64.tar.gz -C /opt creates=/opt/kibana-{{ kibana_version }}-linux-x64.tar.gz</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Link to Kibana Directory</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=/opt/kibana-{{ kibana_version }}-linux-x64</span>
</span><span class='line'>        <span class="l-Scalar-Plain">dest=/opt/kibana</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state=link</span>
</span><span class='line'>        <span class="l-Scalar-Plain">force=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Link Kibana to ElasticSearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">lineinfile</span><span class="p-Indicator">:</span> <span class="p-Indicator">&gt;</span>
</span><span class='line'>    <span class="no">dest=/opt/kibana/config/kibana.yml</span>
</span><span class='line'>    <span class="no">regexp=&quot;^elasticsearch_url:&quot;</span>
</span><span class='line'>    <span class="no">line=&#39;elasticsearch_url: &quot;{{ elasticsearch_url }}&quot;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create Kibana Init Script</span>
</span><span class='line'>  <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=initd.conf dest=/etc/init.d/kibana mode=755 owner=root</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ensure Kibana is running</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=kibana state=started</span>
</span></code></pre></td></tr></table></div></figure>

<p>The reverse_proxied ansible role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">download private key file</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws s3 cp {{ reverse_proxy_private_key_s3_path }} /etc/ssl/private/{{ reverse_proxy_private_key }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">private key permissions</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/etc/ssl/private/{{ reverse_proxy_private_key }} mode=600</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">download certificate file</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws s3 cp {{ reverse_proxy_cert_s3_path }} /etc/ssl/certs/{{ reverse_proxy_cert }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">download DH 2048bit encryption</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">aws s3 cp {{ reverse_proxy_dh_pem_s3_path }} /etc/ssl/{{ reverse_proxy_dh_pem }}</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">certificate permissions</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/etc/ssl/certs/{{ reverse_proxy_cert }} mode=644</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=nginx</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">remove default nginx site from sites-emabled</span>
</span><span class='line'>  <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/etc/nginx/sites-enabled/default state=absent</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=nginx.conf.j2 dest=/etc/nginx/nginx.conf mode=644 owner=root group=root</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=restarted</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">path=/var/log/nginx</span>
</span><span class='line'>        <span class="l-Scalar-Plain">mode=0755</span>
</span><span class='line'>        <span class="l-Scalar-Plain">state=directory</span>
</span></code></pre></td></tr></table></div></figure>

<p>This role downloads a private SSL Key and a Certificate from a <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/UsingBucket.html">S3 bucket</a> that is security controlled through <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html">IAM</a>. This allows us to configure nginx to act as a proxy. The nginx proxy template is available to <a href="https://gist.github.com/stack72/1d76839c6783bd7eea33">view</a>.</p>

<p>We can then pass a number of variables to our role for use within ansible:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">reverse_proxy_private_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mydomain.key</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_private_key_s3_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3://my-bucket/certs/mydomain/mydomain.key</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_cert</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mydomain.crt</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_cert_s3_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3://my-bucket/certs/mydomain/mydomain.crt</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_dh_pem_s3_path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">s3://my-bucket/certs/dhparams.pem</span>
</span><span class='line'><span class="l-Scalar-Plain">reverse_proxy_dh_pem</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dhparams.pem</span>
</span><span class='line'><span class="l-Scalar-Plain">proxy_urls</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">reverse_proxy_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/</span>
</span><span class='line'>    <span class="l-Scalar-Plain">reverse_proxy_upstream_port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3000</span>
</span><span class='line'><span class="l-Scalar-Plain">kibana_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4.1.0</span>
</span><span class='line'><span class="l-Scalar-Plain">elasticsearch_url</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://myes.com:9200</span>
</span></code></pre></td></tr></table></div></figure>

<p>This allows me to easily change the configuration of nginx to patch security vulnerabilities easily.</p>

<h3>Deploying Kibana with Terraform</h3>

<p>The infrastructure of the Kibana cluster is now pretty easy. The Terraform script now looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;kibana&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Kibana Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Kibana Node&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;kibana_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-elb-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;Kibana Elastic Load Balancer Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;Kibana Load Balancer&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_elb&quot; &quot;kibana_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-elb&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">subnets = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cross_zone_load_balancing = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_draining = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">internal = true</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 443</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 80</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthy_threshold   = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">unhealthy_threshold = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval            = 10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">target              = &quot;TCP:443&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout             = 5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_launch_configuration&quot; &quot;kibana_launch_config&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image_id = &quot;${var.kibana_ami_id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">instance_type = &quot;${var.kibana_instance_type}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">iam_instance_profile = &quot;app-server&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">key_name = &quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.kibana.id}&quot;,&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enable_monitoring = false</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">root_block_device {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volume_size = &quot;${var.kibana_volume_size}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">lifecycle {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">create_before_destroy = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_autoscaling_group&quot; &quot;kibana_autoscale_group&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;kibana-autoscale-group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">availability_zones = [&quot;${aws_subnet.primary-private.availability_zone}&quot;,&quot;${aws_subnet.secondary-private.availability_zone}&quot;,&quot;${aws_subnet.tertiary-private.availability_zone}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_zone_identifier = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">launch_configuration = &quot;${aws_launch_configuration.kibana_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">min_size = 2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">max_size = 100</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_type = &quot;EC2&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">load_balancers = [&quot;${aws_elb.kibana_elb.name}&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;Name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;kibana&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;role&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;kibana&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${aws_elb.kibana_elb.name}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_region&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${var.aws_region}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This allows me to scale my system up or down just by changing the values in my Terraform configuration. When the instances are instantiated, the Kibana instances are added to the ELB and they are then available to serve traffic</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">Building an ElasticSearch Cluster in AWS With Packer and Terraform</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-02T12:47:00+00:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As discussed in a <a href="http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">previous post</a>, I like to build separate <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> for each of my systems. This allows me to scale up and recycle nodes easily. I have been doing this with <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> for a while now. I usually build an AMI with <a href="https://packer.io/">Packer</a> and <a href="http://www.ansible.com/">Ansible</a> and I use <a href="https://terraform.io/">Terraform</a> to roll out the infrastructure</p>

<h3>Building ElasticSearch AMIs with Packer</h3>

<p>The packer template looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;variables&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;ami_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;private_subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;security_group_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;packer_build_number&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;ElasticSearch Image&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;builders&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;ami_name&quot;</span><span class="p">:</span> <span class="s2">&quot;elasticsearch-{{user `packer_build_number`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;availability_zone&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1a&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;iam_instance_profile&quot;</span><span class="p">:</span> <span class="s2">&quot;app-server&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;instance_type&quot;</span><span class="p">:</span> <span class="s2">&quot;t2.small&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;region&quot;</span><span class="p">:</span> <span class="s2">&quot;eu-west-1&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;run_tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;packer&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;security_group_ids&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;{{user `security_group_id`}}&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;source_ami&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `ami_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;ssh_username&quot;</span><span class="p">:</span> <span class="s2">&quot;ubuntu&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;subnet_id&quot;</span><span class="p">:</span> <span class="s2">&quot;{{user `private_subnet_id`}}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;elasticsearch-packer-image&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;amazon-ebs&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'>  <span class="nt">&quot;provisioners&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;inline&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;sleep 10&quot;</span> <span class="p">]</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="s2">&quot;install_dependencies.sh&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;execute_command&quot;</span><span class="p">:</span> <span class="s2">&quot;echo &#39;&#39; | {{ .Vars }} sudo -E -S sh &#39;{{ .Path }}&#39;&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ansible-local&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;playbook_file&quot;</span><span class="p">:</span> <span class="s2">&quot;elasticsearch.yml&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;extra_arguments&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>        <span class="s2">&quot;--module-path=./modules&quot;</span>
</span><span class='line'>      <span class="p">],</span>
</span><span class='line'>      <span class="nt">&quot;playbook_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;../../&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is essentially a pretty simple script and builds an AWS Instance in a private subnet of my choice in eu-west-1a in AWS. </p>

<h4>install_dependencies.sh</h4>

<p>The first part of the script just installs the dependencies that my system has:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'>apt-get update
</span><span class='line'>apt-get upgrade -y
</span><span class='line'>apt-get install -y software-properties-common git
</span><span class='line'>apt-add-repository -y ppa:ansible/ansible apt-get update
</span><span class='line'>
</span><span class='line'><span class="c"># workaround for ubuntu pip bug - https://bugs.launchpad.net/ubuntu/+source/python-pip/+bug/1306991</span>
</span><span class='line'>rm -rf /usr/local/lib/python2.7/dist-packages/requests
</span><span class='line'>apt-get install -y python-dev
</span><span class='line'>
</span><span class='line'>ssh-keyscan -H github.com &gt; /etc/ssh/ssh_known_hosts
</span><span class='line'>
</span><span class='line'>wget https://raw.github.com/pypa/pip/master/contrib/get-pip.py
</span><span class='line'>python get-pip.py
</span><span class='line'>
</span><span class='line'>pip install ansible paramiko PyYAML jinja2 httplib2 netifaces boto awscli six
</span></code></pre></td></tr></table></div></figure>

<h4>Ansible playbook for ElasticSearch</h4>

<p>The ElasticSearch playbook looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">pre_tasks</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">elasticsearch</span>
</span></code></pre></td></tr></table></div></figure>

<p>The playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install ElasticSearch. </p>

<p>The ElasticSearch role looks as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_facts</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ec2_tags</span><span class="p-Indicator">:</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add Oracle Java Repository</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt_repository</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">repo=&#39;ppa:webupd8team/java&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Accept Java 8 Licence</span>
</span><span class='line'>  <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | tee /etc/oracle-java-8-licence-acceptance | /usr/bin/debconf-set-selections</span>
</span><span class='line'>  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">creates</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/oracle-java-8-licence-acceptance</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add ElasticSearch repo public signing key</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">id=46095ACC8548582C1A2699A9D27D666CD88E42B4 url=https://packages.elastic.co/GPG-KEY-elasticsearch state=present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add ElasticSearch repository</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt_repository</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">repo</span><span class="p-Indicator">:</span> <span class="s">&#39;deb</span><span class="nv"> </span><span class="s">http://packages.elasticsearch.org/elasticsearch/{{</span><span class="nv"> </span><span class="s">es_release</span><span class="nv"> </span><span class="s">}}/debian</span><span class="nv"> </span><span class="s">stable</span><span class="nv"> </span><span class="s">main&#39;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install Oracle Java 8</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name={{item}} state=latest</span>
</span><span class='line'>  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oracle-java8-installer</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ca-certificates</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oracle-java8-set-default</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install ElasticSearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=elasticsearch={{ es_version }} state=present</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Copy /etc/default/elasticsearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=elasticsearch dest=/etc/default/elasticsearch</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Copy /etc/elasticsearch/elasticsearch.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=elasticsearch.yml dest=/etc/elasticsearch/elasticsearch.yml</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set elasticsearch service to start on boot</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=elasticsearch enabled=yes</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install plugins</span>
</span><span class='line'>  <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bin/plugin --install {{item.name}}</span>
</span><span class='line'>  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">chdir</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">es_home</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">creates</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">es_home</span><span class="nv"> </span><span class="s">}}/plugins/{{</span><span class="nv"> </span><span class="s">item.plugin_file</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">default(item.name.split(&#39;/&#39;)[1])</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">es_plugins</span>
</span><span class='line'>  <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Restart elasticsearch</span>
</span><span class='line'>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set elasticsearch to be running</span>
</span><span class='line'>  <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=elasticsearch state=running enabled=yes</span>
</span></code></pre></td></tr></table></div></figure>

<p>This is just some basic ansible commands to get the apt-repo, packages and plugins installed in the system. You can find the templates used <a href="https://gist.github.com/stack72/bdef4126ae8b08214bd8">here</a>. The important part to note is that variables are used both in the script <strong>and</strong> in the templates to setup the cluster to the required level.</p>

<p>My variables look as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="l-Scalar-Plain">es_release</span><span class="p-Indicator">:</span> <span class="s">&quot;1.6&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">es_version</span><span class="p-Indicator">:</span> <span class="s">&quot;.0&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">es_home</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/usr/share/elasticsearch</span>
</span><span class='line'><span class="l-Scalar-Plain">es_wait_for_listen</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
</span><span class='line'><span class="l-Scalar-Plain">es_etc</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cluster_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">central_logging_cluster</span>
</span><span class='line'>  <span class="l-Scalar-Plain">discovery.type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ec2</span>
</span><span class='line'>  <span class="l-Scalar-Plain">discovery.ec2.groups</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">elasticsearch-sg</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cloud.aws.region</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">es_default_es_heap_size</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4g</span>
</span><span class='line'><span class="l-Scalar-Plain">es_plugins</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">elasticsearch/elasticsearch-cloud-aws/2.6.0</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">elasticsearch/marvel/latest</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">mobz/elasticsearch-head</span>
</span><span class='line'><span class="l-Scalar-Plain">es_etc_index_number_of_replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span></code></pre></td></tr></table></div></figure>

<p>As I have specified <code>elasticsearch-sg</code> and installed the <code>elasticsearch-cloud-aws</code> plugin, my nodes can auto-discover each other in the aws region. I can build the packer image as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="c1">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">LATEST_UBUNTU_IMAGE=$(curl http://cloud-images.ubuntu.com/locator/ec2/releasesTable | grep eu-west-1 | grep trusty | grep amd64 | grep &quot;\&quot;hvm:ebs\&quot;&quot; | awk -F &quot;[&lt;&gt;]&quot; &#39;{print $3}&#39;)</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">packer build \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var ami_id=$LATEST_UBUNTU_IMAGE \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var security_group_id=MYSGID\</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var private_subnet_id=MYSUBNETID \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">-var packer_build_number=PACKERBUILDNUMBER \</span>
</span><span class='line'>  <span class="l-Scalar-Plain">elasticsearch.json</span>
</span></code></pre></td></tr></table></div></figure>

<p>We are now ready to build the infrastructure for the cluster</p>

<h3>Building an ElasticSearch Cluster with Terraform</h3>

<p>The infrastructure of the ElasticSearch cluster is now pretty easy. I deploy my nodes into a <a href="https://aws.amazon.com/vpc/">VPC</a> and onto private subnets so that they are not externally accessible. I have an <a href="https://aws.amazon.com/elasticloadbalancing/">ELB</a> in place across the nodes so that I can easily get to the ElasticSearch plugins like <a href="https://www.elastic.co/guide/en/marvel/current/index.html">Marvel</a> and <a href="https://mobz.github.io/elasticsearch-head/">Head</a>.</p>

<p>The Terraform configuration is as follows:  </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
</pre></td><td class='code'><pre><code class='YAML'><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;elasticsearch&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;ElasticSearch Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 9400</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.elasticsearch_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 9400</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;ElasticSearch Node&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_security_group&quot; &quot;elasticsearch_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-elb-sg&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">description = &quot;ElasticSearch Elastic Load Balancer Security Group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_id = &quot;${aws_vpc.default.id}&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">ingress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port   = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">egress {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">from_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">to_port = &quot;0&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">protocol = &quot;-1&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">cidr_blocks = [&quot;0.0.0.0/0&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tags {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Name = &quot;ElasticSearch Load Balancer&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_elb&quot; &quot;elasticsearch_elb&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-elb&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">subnets = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.elasticsearch_elb.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">cross_zone_load_balancing = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">connection_draining = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">internal = true</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">listener {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_port      = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">instance_protocol  = &quot;tcp&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_port            = 9200</span>
</span><span class='line'>    <span class="l-Scalar-Plain">lb_protocol        = &quot;tcp&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">healthy_threshold   = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">unhealthy_threshold = 2</span>
</span><span class='line'>    <span class="l-Scalar-Plain">interval            = 10</span>
</span><span class='line'>    <span class="l-Scalar-Plain">target              = &quot;TCP:9200&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">timeout             = 5</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_autoscaling_group&quot; &quot;elasticsearch_autoscale_group&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name = &quot;elasticsearch-autoscale-group&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">availability_zones = [&quot;${aws_subnet.primary-private.availability_zone}&quot;,&quot;${aws_subnet.secondary-private.availability_zone}&quot;,&quot;${aws_subnet.tertiary-private.availability_zone}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">vpc_zone_identifier = [&quot;${aws_subnet.primary-private.id}&quot;,&quot;${aws_subnet.secondary-private.id}&quot;,&quot;${aws_subnet.tertiary-private.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">launch_configuration = &quot;${aws_launch_configuration.elasticsearch_launch_config.id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">min_size = 3</span>
</span><span class='line'>  <span class="l-Scalar-Plain">max_size = 100</span>
</span><span class='line'>  <span class="l-Scalar-Plain">desired = 3</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_grace_period = &quot;900&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">health_check_type = &quot;EC2&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">load_balancers = [&quot;${aws_elb.elasticsearch_elb.name}&quot;]</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;Name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;elasticsearch&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;role&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;elasticsearch&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_name&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${aws_elb.elasticsearch_elb.name}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">tag {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">key = &quot;elb_region&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">value = &quot;${var.aws_region}&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">propagate_at_launch = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">resource &quot;aws_launch_configuration&quot; &quot;elasticsearch_launch_config&quot; {</span>
</span><span class='line'>  <span class="l-Scalar-Plain">image_id = &quot;${var.elasticsearch_ami_id}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">instance_type = &quot;${var.elasticsearch_instance_type}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">iam_instance_profile = &quot;app-server&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">key_name = &quot;${aws_key_pair.terraform.key_name}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">security_groups = [&quot;${aws_security_group.elasticsearch.id}&quot;,&quot;${aws_security_group.node.id}&quot;]</span>
</span><span class='line'>  <span class="l-Scalar-Plain">enable_monitoring = false</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">lifecycle {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">create_before_destroy = true</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="l-Scalar-Plain">root_block_device {</span>
</span><span class='line'>    <span class="l-Scalar-Plain">volume_size = &quot;${var.elasticsearch_volume_size}&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">}</span>
</span><span class='line'><span class="l-Scalar-Plain">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>This allows me to scale my system up or down just by changing the values in my Terraform configuration. When the instances are instantiatied, the ElasticSearch cloud plugin discovers the other members of the cluster and allows the node to join the cluster</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/30/autoscaling-group-notifications-with-terraform-and-aws-lambda/">Autoscaling Group Notifications With Terraform and AWS Lambda</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-30T13:51:00+00:00" pubdate data-updated="true">Dec 30<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I use Autoscaling Groups in AWS for all of my systems. The main benefit for me here was to make sure that when a node died in AWS, the Autoscaling Group policy made sure that the node was replaced. I wanted to get some visibility of when the Autoscaling Group was launching and terminating nodes and decided that posting notifications to <a href="https://slack.com/">Slack</a> would be a good way of getting this. With <a href="https://terraform.io/">Terraform</a> and <a href="http://docs.aws.amazon.com/lambda/latest/dg/welcome.html">AWS Lambda</a>, I was able to make this happen.</p>

<p><strong>This post assumes that you are already setup and running with Terraform</strong></p>

<p>Create an IAM Role that allows access to AWS Lambda:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_iam_role" "slack_iam_lambda" {
</span><span class='line'>    name = "slack-iam-lambda"
</span><span class='line'>    assume_role_policy = &lt;&lt;EOF
</span><span class='line'>{
</span><span class='line'>  "Version": "2012-10-17",
</span><span class='line'>  "Statement": [
</span><span class='line'>    {
</span><span class='line'>      "Action": "sts:AssumeRole",
</span><span class='line'>      "Principal": {
</span><span class='line'>        "Service": "lambda.amazonaws.com"
</span><span class='line'>      },
</span><span class='line'>      "Effect": "Allow",
</span><span class='line'>      "Sid": ""
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span><span class='line'>EOF
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>Create a <a href="GIST%20GOES%20HERE">lambda function</a> as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_lambda_function" "slack_notify" {
</span><span class='line'>  filename = "slackNotify.zip"
</span><span class='line'>  function_name = "slackNotify"
</span><span class='line'>  role = "${aws_iam_role.slack_iam_lambda.arn}"
</span><span class='line'>  handler = "slackNotify.handler"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>We assume here, that you have already created a Slack Integration. The hook URL from that integration is required for the lambda contents. </p>

<p>The filename <code>slackNotify.zip</code> is a zip of a file called <code>slackNotify.js</code>. The contents of that js file are <a href="https://gist.github.com/stack72/ad97da2df376754e413a">available</a></p>

<p>Terraform currently does not support hooking AWS Lambda up to SNS Event Sources. Therefore, unfortunately, there is a manual step required to configure the Lambda to talk to the SNS Topic. There is a PR in Terraform to allow this to be automated as well.</p>

<p>In the AWS Console, go to Lambda and then chose the Lambda function. </p>

<p><img src="/images/lambda_function.png" alt="Image"></p>

<p>Go to the <code>Event Sources</code> tab:</p>

<p><img src="/images/lambda_function_event_sources.png" alt="Image"></p>

<p>Click on <code>Add Event Source</code> and then choose <code>SNS</code> from the dropdown and then make sure you chose the correct SNS Topic name:</p>

<p><img src="/images/lambda_function_sns_topic.png" alt="Image"></p>

<p>We then use another Terraform resource to attach the Autoscale Groups to the Lambda as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_autoscaling_notification" "slack_notifications" {
</span><span class='line'>  group_names = [
</span><span class='line'>    "admin-api-autoscale-group",
</span><span class='line'>    "rundeck-autoscale-group",
</span><span class='line'>  ]
</span><span class='line'>  notifications  = [
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE_ERROR",
</span><span class='line'>    "autoscaling:TEST_NOTIFICATION"
</span><span class='line'>  ]
</span><span class='line'>  topic_arn = "${aws_sns_topic.asg_slack_notifications.arn}"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>As we have configured notifications for autoscaling:TEST_NOTIFICATION, when you apply this configuration with Terraform, you will see something similar to the following in Slack:</p>

<p><img src="/images/slack_test_notification.png" alt="Image"></p>

<p>In the current infrastructure I manage, there are 27 Autoscale groups. I don&#39;t really want to add 27 hardcoded group<em>names in the aws</em>autoscaling_notifcation in Terraform. </p>

<p>I wanted to take advantage of a <a href="https://www.terraform.io/docs/modules/usage.html">Terraform module</a>. In a nutshell, the module does a lookup of all the Autoscaling Groups in a region and then passes that list into the Terraform resource.</p>

<p>The output of the <a href="https://github.com/stack72/tf_aws_autoscalegroup_names">module</a> looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "variable": {
</span><span class='line'>    "autoscalegroup_names": {
</span><span class='line'>      "description": "List of autoscalegroup names for a region",
</span><span class='line'>      "default": {
</span><span class='line'>        "eu-west-1": "admin-api-autoscale-group,dash-autoscale-group,demo-autoscale-group,docker-v2-autoscale-group,elasticsearch-autoscale-group,faces-autoscale-group,internal-api-autoscale-group,jenkins-master-autoscale-group,kafka-autoscale-group,landscapes-autoscale-group",
</span><span class='line'>        "ap-southeast-1": "",
</span><span class='line'>        "ap-southeast-2": "",
</span><span class='line'>        "eu-central-1": "",
</span><span class='line'>        "ap-northeast-1": "",
</span><span class='line'>        "us-east-1": "",
</span><span class='line'>        "sa-east-1": "",
</span><span class='line'>        "us-west-1": "",
</span><span class='line'>        "us-west-2": ""
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>I then pass this into the Terraform resource as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module "autoscalegroups" {
</span><span class='line'>  source = "github.com/stack72/tf_aws_autoscalegroup_names"
</span><span class='line'>  region = "${var.aws_region}"
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_autoscaling_notification" "slack_notifications" {
</span><span class='line'>  group_names = [
</span><span class='line'>    "${split(",", module.autoscalegroups.asg_names)}",
</span><span class='line'>  ]
</span><span class='line'>  notifications  = [
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
</span><span class='line'>    "autoscaling:EC2_INSTANCE_TERMINATE_ERROR",
</span><span class='line'>    "autoscaling:TEST_NOTIFICATION"
</span><span class='line'>  ]
</span><span class='line'>  topic_arn = "${aws_sns_topic.asg_slack_notifications.arn}"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

<p>When anything happens within an Autoscaling Group, I now get notifications as follows:</p>

<p><img src="/images/termination_notification.png" alt="Image">
<img src="/images/launch_notification.png" alt="Image"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">The Quest for Infrastructure Management 2.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-09T10:50:00+00:00" pubdate data-updated="true">Nov 9<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#39;ve long been a configuration management tool fan. I have blogged, spoken at conferences and used <a href="https://puppetlabs.com/">Puppet</a> as well as <a href="https://www.chef.io/">Chef</a> and <a href="http://www.ansible.com/">Ansible</a>. The more I use these tools now, the more I realise I&#39;m actually not making my life any easier</p>

<p>Currently, the infrastructure I manage is 100% AWS Cloud based. This has actually changed how I work:</p>

<ol>
<li><p>I have learned to always expect problems so I therefore should have <em>everything</em> 100% automated.</p></li>
<li><p>No server is kept in production for more than 2 weeks</p></li>
</ol>

<p>By combining these 2 ways of working, I can easily recover from outages. The speed of recovery is down to being able to provision the pieces of my system as fast as possible. The simplist way to be able to provision instances fast is to build my own AMIs with <a href="https://packer.io/">Packer</a>. I have come to the realisation that when I boot an instance, I don&#39;t <em>really</em> want to wait for a configuration management tool to run. I have also begun to realise that having a tool change my systems in production can introduce unneeded risk. The Packer templates to build the AMI have <a href="http://serverspec.org/">serverspec</a> tests built into them. This means that at build time, I know if an AMI has been built correctly.</p>

<p>The AWS infrastructure itself is managed by <a href="https://terraform.io/">Terraform</a>. I tend to use AutoScalingGroups and LaunchConfig for the instances and when Terraform is checking the state of the infrastructure, it will look up the latest AMI ID and make sure that it is part of the Launch Configuration. If it isn&#39;t, Terraform will update the Launch Config so that the next machine will be booted from the new AMI.</p>

<p>I use <a href="http://rundeck.org/">Rundeck</a> for orchestrating changes to the infrastructure. I have a job in Rundeck that allows me to recycle <em>all</em> instances in an AutoScalingGroup one at a time and in a HA manner. From building a new AMI, to fully recycling an AutoScalingGroup is about 20 minutes (the packer build itself takes about 12 minutes). So, in theory, it takes me about 20 minutes to release new security patches to all instances in an AutoScalingGroup.</p>

<h3>Isn&#39;t this just &#39;Golden Images&#39;?</h3>

<p>Technically, yes. But the important for me is being able to roll out a fully tested AMI and then not making any additional changes to it in production. I would like to say that my infrastructure is 100% immutable, but after reading a <a href="https://medium.com/@elijahz/what-version-is-your-infrastructure-3a61fe804d0e">recent article</a> by <a href="https://twitter.com/emmajanehw">@emmajanehw</a>, I now realise that can never be the case. Each of my AMIs are versioned and I have a nightly Rundeck job that tells me what version of an AMI a system is built / released with.</p>

<h3>Do I Consider Configuration Management Dead?</h3>

<p>Not at all. I simply do not want to make additional changes to my environments when I know they are working. Right now, I use Ansible to provision my AMI as part of my Packer scripts. So I do believe these tools still need to be part of our eco-system. I could substitute in any configuration management tool to help build my AMIs. The purists could even use bash / shell scripts to do the same job</p>

<h3>Can I only do this if I use *nix / AWS?</h3>

<p>Not at all. At $JOB[-1], we actually were changing our provisioning to allow us to spin up images much faster. We were using a mix of AMIs and VMWare templates for Windows and Ubuntu. By moving in that direction, it would reduce the time taken to provision a box from maybe an hour to minutes.</p>

<p>In my opinion, moving to a more immutable style of infrastructure is the next phase of infra management for me. I believe the learnings from using config management tools in production across 1000s of nodes has helped me move in this direction but YMMV.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/28/devops-and-net-conference/">DevOps and .Net Conference</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-28T12:29:00+00:00" pubdate data-updated="true">Oct 28<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So I just tweeted the following,</p>

<p><img src="/images/DevOpsTweet.png" alt="Image"></p>

<p>Firstly, I&#39;d like to say that this is <em>not</em> about naming and shaming. Secondly, I am not annoyed with the conference at all about the response. The conference I spoke to advertises itself as “engineering talks only” so I wanted to post a few things about that.</p>

<p>In my opinion, the writing of code and the ecosystem of a specific platform is only 10% (or rather a small portion) of what we need to be aware of as software engineers. I am a software developer who works in the infrastructure / ops world now. When I was writing application only code, I was not involved in understanding the entire ecosystem of the software I was working on. In hindsight, I really feel I missed out by not being part of it. Since being part of the infrastructure world, I feel it has actually helped me develop better &amp; more robust software.</p>

<p>Organising conferences is a huge amount of work and is, frankly, hard. I understand that conferences cannot cater for every part of an ecosystem. One thing I do think conferences should do, is to strive to make developers better. DevOps, Continuous Delivery and Infrastructure are / should be things that we, as developers, care about. To dismiss these style of topics from a conference that advertises for “engineering talks only” can help to hinder developers from delivering the best products they can. It may not also make developers understand the importance of software being in production and making money</p>

<p>Food for thought…</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/09/recommended-ops-books/">Recommended Ops Books</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-09T10:50:00+01:00" pubdate data-updated="true">Apr 9<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I created a Github repo to store all the book recommendations I have had since moving more into the operations space. The book categories (so far), include:</p>

<ul>
<li>DevOps / Culture</li>
<li>Continuous Delivery</li>
<li>Systems Thinking</li>
<li>Web Operations</li>
<li>System Architecture</li>
<li>Tooling</li>
</ul>

<p>I want this repository to continue to grow with a list of links to books that people would recommend. If you feel you want to make some recommendations, then please feel free to send a PR!</p>

<p>Otherwise, enjoy the <a href="https://github.com/stack72/ops-books">suggestions</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/04/looking-for-a-new-role/">Looking for a New Role</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-04T14:20:00+00:00" pubdate data-updated="true">Mar 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>EDIT: I am no longer looking for a new role. Thanks to all for the suggestions</p>

<p>TL;DR: I am looking for a new role. I am an infrastructure developer who has a passion for metrics, monitoring and alerting. If you feel that you are interested in me coming to help your engineering team, then get in contact with me</p>

<p><a href="public@paulstack.co.uk">public@paulstack.co.uk</a></p>

<h3>I love working on infrastructure!</h3>

<p>Over the past few years, I have helped transform a team who worked solely in the manual sysadmin space into the configuration management world. This has reduced the time taken to provision a server and get an application into production from a number of weeks, to a number of hours.</p>

<p>Metrics are a key part of my day to day work. I believe that if we don&#39;t measure it then we cannot improve on it and learn from it. I also love to know what is happening with my systems before getting a call from an end user telling me there is a problem.</p>

<p>I have a real drive to make the lives of the engineer teams I work with easier. This means that by helping to create better infrastructure practices, I am helping them and ultimately helping deliver more business value</p>

<h3>What type of company would I work for?</h3>

<p>I have learned over the past few years that being part of a good company is the key to a happy work life. Culture, to me, is absolutely everything. I deeply care about what I do and I really want to be part of a company that holds these same values.</p>

<p>Remote work is something I am interested in, as long as the company is set up for it. I worked remotely a lot in 2014 and found it to be hugely productive as well as beneficial for my previous company because it allowed me to interact to a greater scale with the wider engineer community learning and sharing best practices to keep at the forefront of the industry. I therefore don’t mind where in the world a company is based, but that company must value treating remote employees as importantly as those who are office based</p>

<h3>What about the role?</h3>

<p>I want to be part of a team that care about the systems they create. Working on challenging problems brings out the absolute best in me, and being successful in this means the team I belong to is hugely important because every single person has a role to play in finding and implementing solutions. Working with a team of engineers who always want to improve themselves, their work, and support their colleagues, is what drives me and helps create a supportive team dynamic. Therefore I want to work with engineers who have a good work/life balance and love what they do as much as I do.</p>

<h3>What I definitely don&#39;t want to do</h3>

<p>I don&#39;t want to be a ticket filler. I want to be involved in helping to shape infrastructure systems and helping to drive decisions going forward. In my opinion, automation is key to helping deliver great systems and I really want to be part of delivering those systems</p>

<h3>So hire me!</h3>

<p>If your company is looking for passionate infrastructure developers who always want to improve or If your company has a need (and the willingness) to drive their infrastructure forward and improve then I could be the right person for you. </p>

<p><a href="public@paulstack.co.uk">public@paulstack.co.uk</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
<h1>Follow me on Twitter</h1>
<a href="https://twitter.com/stack72" class="twitter-follow-button" data-show-count="false" data-size="large" data-dnt="true">Follow @stack72</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/15/replacing-a-node-in-a-riak-cluster/">Replacing a Node in a Riak Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/06/building-a-riak-cluster-in-aws-with-packer-and-terraform/">Building a Riak Cluster in AWS With Packer and Terraform</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/04/replacing-the-nodes-in-an-aws-elasticsearch-cluster/">Replacing the Nodes in an AWS ElasticSearch Cluster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/03/deploying-kibana-using-nginx-as-an-ssl-proxy/">Deploying Kibana Using Nginx as an SSL Proxy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">Building an ElasticSearch Cluster in AWS With Packer and Terraform</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Paul Stack (@stack72) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
