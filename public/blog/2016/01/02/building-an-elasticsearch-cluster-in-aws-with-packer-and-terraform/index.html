
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building an ElasticSearch cluster in AWS with Packer and Terraform - Adventures of a wannabe geek!</title>
  <meta name="author" content="Paul Stack (@stack72)">

  
  <meta name="description" content="As discussed in a previous post, I like to build separate AMIs for each of my systems. This allows me to scale up and recycle nodes easily. I have &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Adventures of a wannabe geek!" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-13083957-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Adventures of a wannabe geek!</a></h1>
  
    <h2>Ranting within</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:paulstack.co.uk" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about-me">About Me</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/contact">Contact Details</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building an ElasticSearch Cluster in AWS With Packer and Terraform</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-02T12:47:00+00:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2016</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>As discussed in a <a href="http://www.paulstack.co.uk/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">previous post</a>, I like to build separate <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> for each of my systems. This allows me to scale up and recycle nodes easily. I have been doing this with <a href="https://www.elastic.co/products/elasticsearch">ElasticSearch</a> for a while now. I usually build an AMI with <a href="https://packer.io/">Packer</a> and <a href="http://www.ansible.com/">Ansible</a> and I use <a href="https://terraform.io/">Terraform</a> to roll out the infrastructure</p>

<h3>Building ElasticSearch AMIs with Packer</h3>

<p>The packer template looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  "variables": {
</span><span class='line'>    "ami_id": "",
</span><span class='line'>    "private_subnet_id": "",
</span><span class='line'>    "security_group_id": "",
</span><span class='line'>    "packer_build_number": "",
</span><span class='line'>  },
</span><span class='line'>  "description": "ElasticSearch Image",
</span><span class='line'>  "builders": [
</span><span class='line'>    {
</span><span class='line'>      "ami_name": "elasticsearch-",
</span><span class='line'>      "availability_zone": "eu-west-1a",
</span><span class='line'>      "iam_instance_profile": "app-server",
</span><span class='line'>      "instance_type": "t2.small",
</span><span class='line'>      "region": "eu-west-1",
</span><span class='line'>      "run_tags": {
</span><span class='line'>        "role": "packer"
</span><span class='line'>      },
</span><span class='line'>      "security_group_ids": [
</span><span class='line'>        ""
</span><span class='line'>      ],
</span><span class='line'>      "source_ami": "",
</span><span class='line'>      "ssh_timeout": "10m",
</span><span class='line'>      "ssh_username": "ubuntu",
</span><span class='line'>      "subnet_id": "",
</span><span class='line'>      "tags": {
</span><span class='line'>        "Name": "elasticsearch-packer-image"
</span><span class='line'>      },
</span><span class='line'>      "type": "amazon-ebs"
</span><span class='line'>    }
</span><span class='line'>  ],
</span><span class='line'>  "provisioners": [
</span><span class='line'>    {
</span><span class='line'>      "type": "shell",
</span><span class='line'>      "inline": [ "sleep 10" ]
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "type": "shell",
</span><span class='line'>      "script": "install_dependencies.sh",
</span><span class='line'>      "execute_command": "echo '' |  sudo -E -S sh ''"
</span><span class='line'>    },
</span><span class='line'>    {
</span><span class='line'>      "type": "ansible-local",
</span><span class='line'>      "playbook_file": "elasticsearch.yml",
</span><span class='line'>      "extra_arguments": [
</span><span class='line'>        "--module-path=./modules"
</span><span class='line'>      ],
</span><span class='line'>      "playbook_dir": "../../"
</span><span class='line'>    }
</span><span class='line'>  ]
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This is essentially a pretty simple script and builds an AWS Instance in a private subnet of my choice in eu-west-1a in AWS.</p>

<h4>install_dependencies.sh</h4>

<p>The first part of the script just installs the dependencies that my system has:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>apt-get update
</span><span class='line'>apt-get upgrade -y
</span><span class='line'>apt-get install -y software-properties-common git
</span><span class='line'>apt-add-repository -y ppa:ansible/ansible apt-get update
</span><span class='line'>
</span><span class='line'># workaround for ubuntu pip bug - https://bugs.launchpad.net/ubuntu/+source/python-pip/+bug/1306991
</span><span class='line'>rm -rf /usr/local/lib/python2.7/dist-packages/requests
</span><span class='line'>apt-get install -y python-dev
</span><span class='line'>
</span><span class='line'>ssh-keyscan -H github.com &gt; /etc/ssh/ssh_known_hosts
</span><span class='line'>
</span><span class='line'>wget https://raw.github.com/pypa/pip/master/contrib/get-pip.py
</span><span class='line'>python get-pip.py
</span><span class='line'>
</span><span class='line'>pip install ansible paramiko PyYAML jinja2 httplib2 netifaces boto awscli six
</span></code></pre></td></tr></table></div></figure>


<h4>Ansible playbook for ElasticSearch</h4>

<p>The ElasticSearch playbook looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- hosts: all
</span><span class='line'>  sudo: yes
</span><span class='line'>
</span><span class='line'>  pre_tasks:
</span><span class='line'>    - ec2_tags:
</span><span class='line'>    - ec2_facts:
</span><span class='line'>
</span><span class='line'>  roles:
</span><span class='line'>    - base
</span><span class='line'>    - elasticsearch</span></code></pre></td></tr></table></div></figure>


<p>The playbook installs a base role for all the base pieces of my system (e.g. Logstash, Sensu-client, prometheus node_exporter) and then proceeds to install ElasticSearch.</p>

<p>The ElasticSearch role looks as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- ec2_facts:
</span><span class='line'>- ec2_tags:
</span><span class='line'>
</span><span class='line'>- name: Add Oracle Java Repository
</span><span class='line'>  apt_repository: repo='ppa:webupd8team/java'
</span><span class='line'>
</span><span class='line'>- name: Accept Java 8 Licence
</span><span class='line'>  shell: echo oracle-java8-installer shared/accepted-oracle-license-v1-1 select true | tee /etc/oracle-java-8-licence-acceptance | /usr/bin/debconf-set-selections
</span><span class='line'>  args:
</span><span class='line'>    creates: /etc/oracle-java-8-licence-acceptance
</span><span class='line'>
</span><span class='line'>- name: Add ElasticSearch repo public signing key
</span><span class='line'>  apt_key: id=46095ACC8548582C1A2699A9D27D666CD88E42B4 url=https://packages.elastic.co/GPG-KEY-elasticsearch state=present
</span><span class='line'>
</span><span class='line'>- name: Add ElasticSearch repository
</span><span class='line'>  apt_repository:
</span><span class='line'>    repo: 'deb http://packages.elasticsearch.org/elasticsearch//debian stable main'
</span><span class='line'>    state: present
</span><span class='line'>
</span><span class='line'>- name: Install Oracle Java 8
</span><span class='line'>  apt: name= state=latest
</span><span class='line'>  with_items:
</span><span class='line'>    - oracle-java8-installer
</span><span class='line'>    - ca-certificates
</span><span class='line'>    - oracle-java8-set-default
</span><span class='line'>
</span><span class='line'>- name: Install ElasticSearch
</span><span class='line'>  apt: name=elasticsearch= state=present
</span><span class='line'>  notify: Restart elasticsearch
</span><span class='line'>
</span><span class='line'>- name: Copy /etc/default/elasticsearch
</span><span class='line'>  template: src=elasticsearch dest=/etc/default/elasticsearch
</span><span class='line'>  notify: Restart elasticsearch
</span><span class='line'>
</span><span class='line'>- name: Copy /etc/elasticsearch/elasticsearch.yml
</span><span class='line'>  template: src=elasticsearch.yml dest=/etc/elasticsearch/elasticsearch.yml
</span><span class='line'>  notify: Restart elasticsearch
</span><span class='line'>
</span><span class='line'>- name: Set elasticsearch service to start on boot
</span><span class='line'>  service: name=elasticsearch enabled=yes
</span><span class='line'>
</span><span class='line'>- name: Install plugins
</span><span class='line'>  command: bin/plugin --install 
</span><span class='line'>  args:
</span><span class='line'>    chdir: ""
</span><span class='line'>    creates: "/plugins/"
</span><span class='line'>  with_items: es_plugins
</span><span class='line'>  notify: Restart elasticsearch
</span><span class='line'>
</span><span class='line'>- name: Set elasticsearch to be running
</span><span class='line'>  service: name=elasticsearch state=running enabled=yes
</span></code></pre></td></tr></table></div></figure>


<p>This is just some basic ansible commands to get the apt-repo, packages and plugins installed in the system. You can find the templates used <a href="https://gist.github.com/stack72/bdef4126ae8b08214bd8">here</a>. The important part to note is that variables are used both in the script <strong>and</strong> in the templates to setup the cluster to the required level.</p>

<p>My variables look as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>es_release: "1.6"
</span><span class='line'>es_version: ".0"
</span><span class='line'>es_home: /usr/share/elasticsearch
</span><span class='line'>es_wait_for_listen: yes
</span><span class='line'>es_etc:
</span><span class='line'>  cluster_name: central_logging_cluster
</span><span class='line'>  discovery.type: ec2
</span><span class='line'>  discovery.ec2.groups: elasticsearch-sg
</span><span class='line'>  cloud.aws.region: ""
</span><span class='line'>es_default_es_heap_size: 4g
</span><span class='line'>es_plugins:
</span><span class='line'>  - name: elasticsearch/elasticsearch-cloud-aws/2.6.0
</span><span class='line'>  - name: elasticsearch/marvel/latest
</span><span class='line'>  - name: mobz/elasticsearch-head
</span><span class='line'>es_etc_index_number_of_replicas: 2</span></code></pre></td></tr></table></div></figure>


<p>As I have specified <code>elasticsearch-sg</code> and installed the <code>elasticsearch-cloud-aws</code> plugin, my nodes can auto-discover each other in the aws region. I can build the packer image as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>LATEST_UBUNTU_IMAGE=$(curl http://cloud-images.ubuntu.com/locator/ec2/releasesTable | grep eu-west-1 | grep trusty | grep amd64 | grep "\"hvm:ebs\"" | awk -F "[&lt;&gt;]" '{print $3}')
</span><span class='line'>
</span><span class='line'>packer build \
</span><span class='line'>  -var ami_id=$LATEST_UBUNTU_IMAGE \
</span><span class='line'>  -var security_group_id=MYSGID\
</span><span class='line'>  -var private_subnet_id=MYSUBNETID \
</span><span class='line'>  -var packer_build_number=PACKERBUILDNUMBER \
</span><span class='line'>  elasticsearch.json
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>We are now ready to build the infrastructure for the cluster</p>

<h3>Building an ElasticSearch Cluster with Terraform</h3>

<p>The infrastructure of the ElasticSearch cluster is now pretty easy. I deploy my nodes into a <a href="https://aws.amazon.com/vpc/">VPC</a> and onto private subnets so that they are not externally accessible. I have an <a href="https://aws.amazon.com/elasticloadbalancing/">ELB</a> in place across the nodes so that I can easily get to the ElasticSearch plugins like <a href="https://www.elastic.co/guide/en/marvel/current/index.html">Marvel</a> and <a href="https://mobz.github.io/elasticsearch-head/">Head</a>.</p>

<p>The Terraform configuration is as follows:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resource "aws_security_group" "elasticsearch" {
</span><span class='line'>  name = "elasticsearch-sg"
</span><span class='line'>  description = "ElasticSearch Security Group"
</span><span class='line'>  vpc_id = "${aws_vpc.default.id}"
</span><span class='line'>
</span><span class='line'>  ingress {
</span><span class='line'>    from_port = 9200
</span><span class='line'>    to_port   = 9400
</span><span class='line'>    protocol  = "tcp"
</span><span class='line'>    security_groups = ["${aws_security_group.elasticsearch_elb.id}"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  ingress {
</span><span class='line'>    from_port = 9200
</span><span class='line'>    to_port   = 9400
</span><span class='line'>    protocol  = "tcp"
</span><span class='line'>    security_groups = ["${aws_security_group.node.id}"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  egress {
</span><span class='line'>    from_port = "0"
</span><span class='line'>    to_port = "0"
</span><span class='line'>    protocol = "-1"
</span><span class='line'>    cidr_blocks = ["0.0.0.0/0"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  tags {
</span><span class='line'>    Name = "ElasticSearch Node"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>resource "aws_security_group" "elasticsearch_elb" {
</span><span class='line'>  name = "elasticsearch-elb-sg"
</span><span class='line'>  description = "ElasticSearch Elastic Load Balancer Security Group"
</span><span class='line'>  vpc_id = "${aws_vpc.default.id}"
</span><span class='line'>
</span><span class='line'>  ingress {
</span><span class='line'>    from_port = 9200
</span><span class='line'>    to_port   = 9200
</span><span class='line'>    protocol  = "tcp"
</span><span class='line'>    security_groups = ["${aws_security_group.node.id}"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  egress {
</span><span class='line'>    from_port = "0"
</span><span class='line'>    to_port = "0"
</span><span class='line'>    protocol = "-1"
</span><span class='line'>    cidr_blocks = ["0.0.0.0/0"]
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  tags {
</span><span class='line'>    Name = "ElasticSearch Load Balancer"
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_elb" "elasticsearch_elb" {
</span><span class='line'>  name = "elasticsearch-elb"
</span><span class='line'>  subnets = ["${aws_subnet.primary-private.id}","${aws_subnet.secondary-private.id}","${aws_subnet.tertiary-private.id}"]
</span><span class='line'>  security_groups = ["${aws_security_group.elasticsearch_elb.id}"]
</span><span class='line'>  cross_zone_load_balancing = true
</span><span class='line'>  connection_draining = true
</span><span class='line'>  internal = true
</span><span class='line'>
</span><span class='line'>  listener {
</span><span class='line'>    instance_port      = 9200
</span><span class='line'>    instance_protocol  = "tcp"
</span><span class='line'>    lb_port            = 9200
</span><span class='line'>    lb_protocol        = "tcp"
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  health_check {
</span><span class='line'>    healthy_threshold   = 2
</span><span class='line'>    unhealthy_threshold = 2
</span><span class='line'>    interval            = 10
</span><span class='line'>    target              = "TCP:9200"
</span><span class='line'>    timeout             = 5
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_autoscaling_group" "elasticsearch_autoscale_group" {
</span><span class='line'>  name = "elasticsearch-autoscale-group"
</span><span class='line'>  availability_zones = ["${aws_subnet.primary-private.availability_zone}","${aws_subnet.secondary-private.availability_zone}","${aws_subnet.tertiary-private.availability_zone}"]
</span><span class='line'>  vpc_zone_identifier = ["${aws_subnet.primary-private.id}","${aws_subnet.secondary-private.id}","${aws_subnet.tertiary-private.id}"]
</span><span class='line'>  launch_configuration = "${aws_launch_configuration.elasticsearch_launch_config.id}"
</span><span class='line'>  min_size = 3
</span><span class='line'>  max_size = 100
</span><span class='line'>  desired = 3
</span><span class='line'>  health_check_grace_period = "900"
</span><span class='line'>  health_check_type = "EC2"
</span><span class='line'>  load_balancers = ["${aws_elb.elasticsearch_elb.name}"]
</span><span class='line'>
</span><span class='line'>  tag {
</span><span class='line'>    key = "Name"
</span><span class='line'>    value = "elasticsearch"
</span><span class='line'>    propagate_at_launch = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  tag {
</span><span class='line'>    key = "role"
</span><span class='line'>    value = "elasticsearch"
</span><span class='line'>    propagate_at_launch = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  tag {
</span><span class='line'>    key = "elb_name"
</span><span class='line'>    value = "${aws_elb.elasticsearch_elb.name}"
</span><span class='line'>    propagate_at_launch = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  tag {
</span><span class='line'>    key = "elb_region"
</span><span class='line'>    value = "${var.aws_region}"
</span><span class='line'>    propagate_at_launch = true
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>resource "aws_launch_configuration" "elasticsearch_launch_config" {
</span><span class='line'>  image_id = "${var.elasticsearch_ami_id}"
</span><span class='line'>  instance_type = "${var.elasticsearch_instance_type}"
</span><span class='line'>  iam_instance_profile = "app-server"
</span><span class='line'>  key_name = "${aws_key_pair.terraform.key_name}"
</span><span class='line'>  security_groups = ["${aws_security_group.elasticsearch.id}","${aws_security_group.node.id}"]
</span><span class='line'>  enable_monitoring = false
</span><span class='line'>
</span><span class='line'>  lifecycle {
</span><span class='line'>    create_before_destroy = true
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  root_block_device {
</span><span class='line'>    volume_size = "${var.elasticsearch_volume_size}"
</span><span class='line'>  }
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This allows me to scale my system up or down just by changing the values in my Terraform configuration. When the instances are instantiatied, the ElasticSearch cloud plugin discovers the other members of the cluster and allows the node to join the cluster</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Paul Stack (@stack72)</span></span>

      








  


<time datetime="2016-01-02T12:47:00+00:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2016</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/automation/'>automation</a>, <a class='category' href='/blog/categories/aws/'>aws</a>, <a class='category' href='/blog/categories/elasticsearch/'>elasticsearch</a>, <a class='category' href='/blog/categories/infrastructure/'>infrastructure</a>, <a class='category' href='/blog/categories/terraform/'>terraform</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/" data-via="" data-counturl="http://paulstack.co.uk/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/30/autoscaling-group-notifications-with-terraform-and-aws-lambda/" title="Previous Post: Autoscaling Group Notifications with Terraform and AWS Lambda">&laquo; Autoscaling Group Notifications with Terraform and AWS Lambda</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
<h1>Follow me on Twitter</h1>
<a href="https://twitter.com/stack72" class="twitter-follow-button" data-show-count="false" data-size="large" data-dnt="true">Follow @stack72</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/02/building-an-elasticsearch-cluster-in-aws-with-packer-and-terraform/">Building an ElasticSearch Cluster in AWS With Packer and Terraform</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/30/autoscaling-group-notifications-with-terraform-and-aws-lambda/">Autoscaling Group Notifications With Terraform and AWS Lambda</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/09/the-quest-for-infra-management-2-dot-0/">The Quest for Infrastructure Management 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/28/devops-and-net-conference/">DevOps and .Net Conference</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/09/recommended-ops-books/">Recommended Ops Books</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Paul Stack (@stack72) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
